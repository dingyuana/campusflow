
---

## Day 1ï¼šåŸºç¡€ Agent ä¸ ReAct èŒƒå¼

#### ä¸€ã€å‰æœŸçŸ¥è¯†ï¼ˆè¯¾å‰é¢„ä¹ ï¼Œ1hï¼‰

**å‚è€ƒèµ„æ–™**ï¼š
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/LLMåŸºç¡€æ¦‚å¿µ.md` - å¤§æ¨¡å‹æ¨ç†åŸç†
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/ReActè®ºæ–‡è§£è¯».md` - Reasoning + Acting æœºåˆ¶

1. **ReAct æ ¸å¿ƒæ€æƒ³**ï¼šç†è§£ Thought â†’ Action â†’ Observation çš„å¾ªç¯æœºåˆ¶ï¼›
2. **Tool Calling åŸç†**ï¼šFunction Calling çš„ JSON Schema å®šä¹‰ä¸å‚æ•°ä¼ é€’ï¼›
3. **åŒæ­¥ vs å¼‚æ­¥**ï¼šPython `async/await` åŸºç¡€ï¼ˆä¸ºåç»­ Agent å¼‚æ­¥æ‰§è¡Œé“ºå«ï¼‰ã€‚

#### äºŒã€å®éªŒç›®æ ‡

1. æŒæ¡ ReAct èŒƒå¼çš„å®ç°é€»è¾‘ï¼Œç†è§£ Agent çš„"æ€è€ƒ-è¡ŒåŠ¨-è§‚å¯Ÿ"å¾ªç¯ï¼›
2. å®ç°åŸºç¡€ Tool Callingï¼ˆå·¥å…·å®šä¹‰ã€ç»‘å®šã€è°ƒç”¨ï¼‰ï¼›
3. æ„å»ºç¬¬ä¸€ä¸ªæ ¡å›­å’¨è¯¢ Agentï¼Œèƒ½å›ç­”"å›¾ä¹¦é¦†å¼€æ”¾æ—¶é—´"ã€"å­¦è´¹ç¼´çº³æ–¹å¼"ç­‰å¸¸è§é—®é¢˜ã€‚

#### ä¸‰ã€éš¾ç‚¹é‡ç‚¹

- **é‡ç‚¹**ï¼šReAct æç¤ºå·¥ç¨‹ï¼ˆå¦‚ä½•å¼•å¯¼æ¨¡å‹è¾“å‡ºç»“æ„åŒ–æ€è€ƒï¼‰ã€Tool Schema è®¾è®¡ï¼›
- **éš¾ç‚¹**ï¼šå·¥å…·è¿”å›ç»“æœä¸ LLM ä¸Šä¸‹æ–‡çš„è¡”æ¥ï¼ˆObservation å¦‚ä½•å½±å“ä¸‹ä¸€æ­¥ Thoughtï¼‰ã€‚

#### å››ã€çŸ¥è¯†åŸºç¡€

- **å¿…å¤‡**ï¼šPython å­—å…¸ä¸åˆ—è¡¨æ“ä½œã€JSON æ ¼å¼ï¼›
- **å¯é€‰**ï¼šPydantic åŸºç¡€ï¼ˆç”¨äºå·¥å…·å‚æ•°æ ¡éªŒï¼‰ã€‚

#### äº”ã€å®éªŒæ­¥éª¤ï¼ˆ8hï¼Œå« 2h ç†è®ºè®²è§£ï¼‰

**é˜¶æ®µ 1ï¼šç†è®ºè®²è§£ï¼ˆ2hï¼‰**

1. **MAS æ¶æ„å…¥é—¨**ï¼ˆ20minï¼‰ï¼šå• Agent vs å¤š Agentï¼Œä¸ºä»€ä¹ˆè¦ç”¨ ReActï¼Ÿ
2. **ReAct æ·±åº¦è§£æ**ï¼ˆ40minï¼‰ï¼š  
   - æ‰‹å†™ ReAct æµç¨‹å›¾ï¼ˆThought â†’ Action â†’ Observationï¼‰  
   - å°‘æ ·æœ¬æç¤ºï¼ˆFew-shot Promptingï¼‰è®¾è®¡  
3. **Tool Calling æœºåˆ¶**ï¼ˆ30minï¼‰ï¼š  
   - `@tool` è£…é¥°å™¨åŸç†ï¼ˆLangChainï¼‰  
   - å·¥å…·æè¿°å·¥ç¨‹ï¼ˆDescription å†³å®šè°ƒç”¨å‡†ç¡®ç‡ï¼‰  
4. **LangGraph Prebuilt ç®€ä»‹**ï¼ˆ30minï¼‰ï¼š`create_react_agent`  vs  ä»é›¶æ„å»ºã€‚

**é˜¶æ®µ 2ï¼šå®æ“è½åœ°ï¼ˆ6hï¼‰**

**æ­¥éª¤ 1ï¼šç¯å¢ƒå‡†å¤‡ï¼ˆ0.5hï¼‰**

åˆ›å»º Day 1 åˆ†æ”¯ï¼š
```bash
git checkout -b feature/day1-react-agent
uv pip install langgraph langchain-openai python-dotenv -i https://pypi.tuna.tsinghua.edu.cn/simple
```

**æ­¥éª¤ 2ï¼šå·¥å…·å®šä¹‰ï¼ˆ1.5hï¼‰**

åœ¨ `agents/tools/campus_info.py` ä¸­åˆ›å»ºæ ¡å›­ä¿¡æ¯æŸ¥è¯¢å·¥å…·ï¼š

```python
from langchain.tools import tool
from datetime import datetime
import random

@tool
def query_campus_library_status() -> str:
    """æŸ¥è¯¢å›¾ä¹¦é¦†å½“å‰å¼€æ”¾çŠ¶æ€å’Œå‰©ä½™åº§ä½æ•°"""
    # æ¨¡æ‹ŸçœŸå®æ•°æ®ï¼ˆåç»­å¯æ¥çœŸå® APIï¼‰
    current_hour = datetime.now().hour
    is_open = 8 <= current_hour <= 22
    seats_available = random.randint(50, 500) if is_open else 0
    
    return f"å›¾ä¹¦é¦†{'å¼€æ”¾ä¸­' if is_open else 'å·²é—­é¦†'}ï¼Œå‰©ä½™åº§ä½ï¼š{seats_available}"

@tool
def query_tuition_payment(method: str) -> str:
    """
    æŸ¥è¯¢å­¦è´¹ç¼´çº³æ–¹å¼è¯¦æƒ…
    Args:
        method: ç¼´çº³æ–¹å¼ï¼Œå¯é€‰å€¼ï¼š"é“¶è¡Œè½¬è´¦", "æ”¯ä»˜å®", "å¾®ä¿¡æ”¯ä»˜", "ç°åœºç¼´è´¹"
    """
    payment_info = {
        "é“¶è¡Œè½¬è´¦": "è´¦å·ï¼š6222-xxxx-xxxxï¼Œå¼€æˆ·è¡Œï¼šå·¥å•†é“¶è¡ŒXXåˆ†è¡Œï¼Œå¤‡æ³¨ï¼šå­¦å·+å§“å",
        "æ”¯ä»˜å®": "æœç´¢ç”Ÿæ´»å·'XXå¤§å­¦è´¢åŠ¡å¤„'ï¼Œè¾“å…¥å­¦å·æŸ¥è¯¢ç¼´è´¹",
        "å¾®ä¿¡æ”¯ä»˜": "å…³æ³¨å…¬ä¼—å·'XXå¤§å­¦'ï¼Œèœå•æ ã€å­¦ç”ŸæœåŠ¡ã€‘-ã€ç¼´è´¹å¤§å…ã€‘",
        "ç°åœºç¼´è´¹": "è¡Œæ”¿æ¥¼ 302 è´¢åŠ¡å¤„çª—å£ï¼Œå·¥ä½œæ—¥ 9:00-16:00"
    }
    return payment_info.get(method, "ä¸æ”¯æŒè¯¥ç¼´è´¹æ–¹å¼")

@tool
def query_dormitory_info(building: str) -> str:
    """
    æŸ¥è¯¢å®¿èˆæ¥¼åŸºæœ¬ä¿¡æ¯
    Args:
        building: å®¿èˆæ¥¼æ ‹å·ï¼Œå¦‚"A1", "B3"
    """
    dorm_db = {
        "A1": "å››äººé—´ï¼Œç‹¬ç«‹å«æµ´ï¼Œç©ºè°ƒï¼Œ1200å…ƒ/å¹´",
        "A2": "å…­äººé—´ï¼Œå…¬å…±å«æµ´ï¼Œç©ºè°ƒï¼Œ800å…ƒ/å¹´",
        "B3": "å››äººé—´ï¼Œç‹¬ç«‹å«æµ´ï¼Œæ— ç©ºè°ƒï¼Œ1000å…ƒ/å¹´"
    }
    return dorm_db.get(building, "æœªæ‰¾åˆ°è¯¥å®¿èˆæ¥¼ä¿¡æ¯ï¼Œå¯é€‰ï¼šA1, A2, B3")
```

**æ­¥éª¤ 3ï¼šReAct Agent æ„å»ºï¼ˆ2hï¼‰**

åœ¨ `agents/day1_react_agent.py` ä¸­å®ç°å’¨è¯¢ Agentï¼š

```python
import os
from typing import TypedDict, Annotated, Sequence
from langchain_openai import ChatOpenAI
from langchain_core.messages import BaseMessage, HumanMessage, AIMessage, ToolMessage
from langgraph.prebuilt import create_react_agent
from langgraph.graph import StateGraph, END
from agents.tools.campus_info import (
    query_campus_library_status, 
    query_tuition_payment, 
    query_dormitory_info
)

# å·¥å…·é›†åˆ
tools = [query_campus_library_status, query_tuition_payment, query_dormitory_info]

# åˆå§‹åŒ–æ¨¡å‹ï¼ˆä½¿ç”¨å…¼å®¹ OpenAI çš„ APIï¼‰
model = ChatOpenAI(
    model="gpt-4o-mini",
    temperature=0,
    base_url=os.getenv("OPENAI_BASE_URL"),
    api_key=os.getenv("OPENAI_API_KEY")
)

# ä½¿ç”¨ LangGraph Prebuilt åˆ›å»º ReAct Agent
agent_executor = create_react_agent(model, tools)

def run_agent():
    print("ğŸ« æ ¡å›­å’¨è¯¢ Agent å·²å¯åŠ¨ï¼ˆè¾“å…¥ 'exit' é€€å‡ºï¼‰")
    print("ç¤ºä¾‹é—®é¢˜ï¼š'å›¾ä¹¦é¦†ç°åœ¨å¼€æ”¾å—ï¼Ÿ'ã€'æˆ‘æƒ³ç”¨æ”¯ä»˜å®äº¤å­¦è´¹'ã€'A1å®¿èˆæ€ä¹ˆæ ·ï¼Ÿ'\n")
    
    while True:
        user_input = input("ğŸ‘¤ å­¦ç”Ÿï¼š")
        if user_input.lower() == 'exit':
            break
            
        # è°ƒç”¨ Agent
        response = agent_executor.invoke({
            "messages": [HumanMessage(content=user_input)]
        })
        
        # è¾“å‡ºæœ€åä¸€æ¡ AI æ¶ˆæ¯
        ai_message = response["messages"][-1]
        print(f"ğŸ¤– Agentï¼š{ai_message.content}\n")
        
        # æ‰“å°ä¸­é—´æ­¥éª¤ï¼ˆç”¨äºç†è§£ ReAct æµç¨‹ï¼‰
        print("ğŸ” [è°ƒè¯•ä¿¡æ¯] æ‰§è¡Œæ­¥éª¤ï¼š")
        for msg in response["messages"]:
            if msg.type == "ai" and hasattr(msg, "tool_calls") and msg.tool_calls:
                print(f"  Thought: éœ€è¦è°ƒç”¨å·¥å…· {msg.tool_calls[0]['name']}")
            elif msg.type == "tool":
                print(f"  Observation: {msg.content[:50]}...")

if __name__ == "__main__":
    run_agent()
```

**æ­¥éª¤ 4ï¼šReAct æµç¨‹å¯è§†åŒ–ï¼ˆ1hï¼‰**

åœ¨ `utils/visualize.py` ä¸­æ·»åŠ è°ƒè¯•åŠŸèƒ½ï¼Œå¼ºåˆ¶æ‰“å°æ€è€ƒè¿‡ç¨‹ï¼š

```python
def print_react_trace(messages):
    """å¯è§†åŒ– ReAct çš„æ€è€ƒ-è¡ŒåŠ¨-è§‚å¯Ÿé“¾"""
    print("\n" + "="*50)
    print("ğŸ§  ReAct æ‰§è¡Œé“¾è·¯å¯è§†åŒ–")
    print("="*50)
    
    for i, msg in enumerate(messages):
        if msg.type == "human":
            print(f"\n{i}. ğŸ‘¤ ç”¨æˆ·è¾“å…¥: {msg.content}")
        elif msg.type == "ai":
            if hasattr(msg, "tool_calls") and msg.tool_calls:
                tool_name = msg.tool_calls[0]["name"]
                args = msg.tool_calls[0]["args"]
                print(f"{i}. ğŸ”§ Action: è°ƒç”¨ {tool_name}ï¼Œå‚æ•°: {args}")
            else:
                print(f"{i}. ğŸ’¬ Final Answer: {msg.content}")
        elif msg.type == "tool":
            print(f"{i}. ğŸ“Š Observation: {msg.content[:80]}...")
    print("="*50)
```

ä¿®æ”¹ Agent ä»£ç ï¼Œåœ¨è¾“å‡ºä¸­åŠ å…¥ `print_react_trace(response["messages"])`ã€‚

**æ­¥éª¤ 5ï¼šè¾¹ç•Œæµ‹è¯•ï¼ˆ1hï¼‰**

è®¾è®¡æµ‹è¯•ç”¨ä¾‹éªŒè¯ ReAct çš„é²æ£’æ€§ï¼š
1. **æ­£å¸¸æµç¨‹**ï¼š"å›¾ä¹¦é¦†ç°åœ¨èƒ½è¿›å—ï¼Ÿ" â†’ åº”è°ƒç”¨ `query_campus_library_status`
2. **å‚æ•°æå–**ï¼š"B3å®¿èˆæ¡ä»¶å¦‚ä½•ï¼Ÿ" â†’ åº”æ­£ç¡®æå– building="B3"
3. **å¤šè½®æ‹’ç»**ï¼š"ç”·æœ‹å‹èƒ½è¿›å®¿èˆå—ï¼Ÿ" â†’ åº”å›ç­”æ”¿ç­–é—®é¢˜ï¼ˆæ— éœ€å·¥å…·ï¼Œç›´æ¥åŸºäºçŸ¥è¯†ï¼‰
4. **å·¥å…·å¤±è´¥**ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ¥¼æ ‹ "Z9" â†’ è§‚å¯Ÿé”™è¯¯ååº”ä¼˜é›…è¿”å›

**æ­¥éª¤ 6ï¼šä»£ç æäº¤ï¼ˆ0.5hï¼‰**

```bash
git add .
git commit -m "feat(day1): å®ç°åŸºç¡€ ReAct Agent æ ¡å›­å’¨è¯¢åŠŸèƒ½
- æ·»åŠ 3ä¸ªæ ¡å›­ä¿¡æ¯æŸ¥è¯¢å·¥å…·
- ä½¿ç”¨ LangGraph prebuilt æ„å»º Agent
- å®ç° ReAct é“¾è·¯å¯è§†åŒ–è°ƒè¯•"
git push origin feature/day1-react-agent
```

#### å…­ã€è€ƒæ ¸æ–¹æ³•ï¼ˆé‡åŒ–è¯„åˆ†ï¼Œ10 åˆ†ï¼‰

| è€ƒæ ¸é¡¹ | åˆ†å€¼ | è¯„åˆ†æ ‡å‡† |
|-------|------|---------|
| **å·¥å…·å®šä¹‰è§„èŒƒ** | 2 åˆ† | ä½¿ç”¨ `@tool` è£…é¥°å™¨ï¼Œå‡½æ•° docstring åŒ…å«å‚æ•°è¯´æ˜ï¼Œç±»å‹æ³¨è§£æ­£ç¡® |
| **ReAct é€»è¾‘æ­£ç¡®** | 3 åˆ† | Agent èƒ½æ­£ç¡®è¾“å‡º Thought/Action/Observation å¾ªç¯ï¼Œä¸ hallucinate å·¥å…·ç»“æœ |
| **å¤šå·¥å…·è·¯ç”±** | 2 åˆ† | èƒ½æ ¹æ®é—®é¢˜æ„å›¾é€‰æ‹©æ­£ç¡®å·¥å…·ï¼ˆå­¦è´¹é—®é¢˜è°ƒç¼´è´¹å·¥å…·ï¼Œå®¿èˆé—®é¢˜è°ƒå®¿èˆå·¥å…·ï¼‰ |
| **è¾¹ç•Œå¤„ç†** | 2 åˆ† | å¯¹ä¸å­˜åœ¨çš„æ•°æ®ï¼ˆå¦‚ Z9 å®¿èˆï¼‰è¿”å›å‹å¥½æç¤ºï¼Œä¸æŠ›å‡ºå¼‚å¸¸ |
| **ä»£ç è§„èŒƒ** | 1 åˆ† | ç¬¦åˆ PEP8ï¼Œæäº¤ PR å¹¶åŒ…å«è¿è¡Œæˆªå›¾ |

---

## Day 2ï¼šRAG ç³»ç»Ÿä¸æŠ¥åˆ°æ‰‹å†Œé—®ç­”

#### ä¸€ã€å‰æœŸçŸ¥è¯†ï¼ˆè¯¾å‰é¢„ä¹ ï¼Œ1hï¼‰

**å‚è€ƒèµ„æ–™**ï¼š
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/åµŒå…¥æ¨¡å‹åŸç†.md` - Embedding ä¸å‘é‡ç©ºé—´
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/RAGè®ºæ–‡.md` - Retrieval-Augmented Generation åŸºç¡€

1. **æ–‡æœ¬åµŒå…¥ï¼ˆEmbeddingï¼‰**ï¼šå°†æ–‡æœ¬è½¬ä¸ºå‘é‡çš„åŸç†ï¼Œè¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ï¼‰ï¼›
2. **åˆ†å—ç­–ç•¥ï¼ˆChunkingï¼‰**ï¼šä¸ºä»€ä¹ˆéœ€è¦åˆ‡åˆ†æ–‡æ¡£ï¼Ÿchunk_size ä¸ overlap çš„å½±å“ï¼›
3. **æ··åˆæ£€ç´¢**ï¼šå‘é‡æ£€ç´¢ï¼ˆè¯­ä¹‰åŒ¹é…ï¼‰vs å…³é”®è¯æ£€ç´¢ï¼ˆBM25ï¼‰çš„äº’è¡¥æ€§ã€‚

#### äºŒã€å®éªŒç›®æ ‡

1. å®ç°å®Œæ•´çš„ RAG Pipelineï¼šæ–‡æ¡£åŠ è½½ â†’ åˆ‡åˆ† â†’ å‘é‡åŒ– â†’ æ£€ç´¢ â†’ ç”Ÿæˆï¼›
2. ä¼˜åŒ–åˆ†å—ç­–ç•¥ï¼Œé’ˆå¯¹ã€Šæ ¡å›­æŠ¥åˆ°æ‰‹å†Œã€‹PDF è®¾è®¡åˆç†çš„ chunk_sizeï¼›
3. å®ç°æ··åˆæ£€ç´¢ï¼ˆè¯­ä¹‰ + å…³é”®è¯ï¼‰ï¼Œæå‡ç‰¹å®šæœ¯è¯­ï¼ˆå¦‚"å­¦å·"ã€"ä¸€å¡é€š"ï¼‰çš„å¬å›ç‡ã€‚

#### ä¸‰ã€éš¾ç‚¹é‡ç‚¹

- **é‡ç‚¹**ï¼šé€’å½’å­—ç¬¦åˆ‡åˆ†ä¸è¯­ä¹‰åˆ‡åˆ†çš„åŒºåˆ«ï¼ŒBGE-m3 åµŒå…¥æ¨¡å‹çš„ä½¿ç”¨ï¼›
- **éš¾ç‚¹**ï¼šæ··åˆæ£€ç´¢çš„èåˆæ’åºï¼ˆRerankingï¼‰ï¼Œå¦‚ä½•å¹³è¡¡è¯­ä¹‰ç›¸å…³æ€§ä¸å…³é”®è¯ç²¾ç¡®åŒ¹é…ã€‚

#### å››ã€çŸ¥è¯†åŸºç¡€

- **å¿…å¤‡**ï¼šPDF æ–‡ä»¶ç»“æ„åŸºç¡€ï¼Œå‘é‡æ•°æ®åº“åŸºæœ¬æ¦‚å¿µï¼›
- **å¯é€‰**ï¼šäº†è§£ BM25 ç®—æ³•åŸç†ã€‚

#### äº”ã€å®éªŒæ­¥éª¤ï¼ˆ8hï¼Œå« 2h ç†è®ºè®²è§£ï¼‰

**é˜¶æ®µ 1ï¼šç†è®ºè®²è§£ï¼ˆ2hï¼‰**

1. **RAG æ¶æ„å…¨æ™¯**ï¼ˆ30minï¼‰ï¼šç´¢å¼•ï¼ˆIndexingï¼‰â†’ æ£€ç´¢ï¼ˆRetrievalï¼‰â†’ ç”Ÿæˆï¼ˆGenerationï¼‰ï¼›
2. **åˆ‡åˆ†ç­–ç•¥æ·±åº¦è§£æ**ï¼ˆ40minï¼‰ï¼š  
   - å›ºå®šå­—ç¬¦åˆ‡åˆ† vs é€’å½’å­—ç¬¦åˆ‡åˆ†  
   - è¯­ä¹‰åˆ‡åˆ†ï¼ˆSemantic Chunkingï¼‰åŸç†  
   - é’ˆå¯¹è¡¨æ ¼ã€åˆ—è¡¨çš„ç‰¹æ®Šå¤„ç†  
3. **å‘é‡æ•°æ®åº“ä¸åµŒå…¥æ¨¡å‹**ï¼ˆ30minï¼‰ï¼š  
   - ChromaDB çš„ Collection ä¸ Metadata è¿‡æ»¤  
   - BGE-m3 çš„å¤šè¯­è¨€ä¼˜åŠ¿ï¼ˆä¸­æ–‡ä¼˜åŒ–ï¼‰  
4. **æ··åˆæ£€ç´¢å®æˆ˜**ï¼ˆ20minï¼‰ï¼šEnsemble Retrieverï¼ˆ0.7*è¯­ä¹‰ + 0.3*å…³é”®è¯ï¼‰ã€‚

**é˜¶æ®µ 2ï¼šå®æ“è½åœ°ï¼ˆ6hï¼‰**

**æ­¥éª¤ 1ï¼šæ•°æ®å‡†å¤‡ï¼ˆ0.5hï¼‰**

å‡†å¤‡æµ‹è¯•æ•°æ® `data/æ–°ç”ŸæŠ¥åˆ°æ‰‹å†Œ.pdf`ï¼ˆæä¾›æ¨¡æ‹Ÿ PDFï¼ŒåŒ…å«ï¼šæŠ¥åˆ°æµç¨‹ã€ç¼´è´¹è¯´æ˜ã€å®¿èˆåˆ†é…ã€å†›è®­å®‰æ’ç­‰ç« èŠ‚ï¼‰ã€‚

```bash
git checkout -b feature/day2-rag-system
uv pip install langchain-community chromadb sentence-transformers pypdf -i https://pypi.tuna.tsinghua.edu.cn/simple
```

**æ­¥éª¤ 2ï¼šæ–‡æ¡£åŠ è½½ä¸åˆ‡åˆ†ï¼ˆ1.5hï¼‰**

åœ¨ `db/rag_loader.py` ä¸­å®ç°æ™ºèƒ½åˆ‡åˆ†ï¼š

```python
from langchain_community.document_loaders import PyPDFLoader
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain.schema import Document
import re

def load_and_split_handbook(pdf_path: str):
    """
    åŠ è½½æŠ¥åˆ°æ‰‹å†Œå¹¶è¿›è¡Œè¯­ä¹‰å‹å¥½çš„åˆ‡åˆ†
    ç­–ç•¥ï¼šæŒ‰æ®µè½åˆ‡åˆ†ï¼Œä¿ç•™ä¸Šä¸‹æ–‡æ ‡é¢˜
    """
    loader = PyPDFLoader(pdf_path)
    documents = loader.load()
    
    # é¢„å¤„ç†ï¼šåˆå¹¶é¡µçœ‰é¡µè„šï¼Œæå–æ ‡é¢˜å±‚çº§
    processed_docs = []
    for doc in documents:
        # æ¸…ç†é¡µç ç­‰å™ªå£°
        cleaned = re.sub(r'\n\s*\d+\s*\n', '\n', doc.page_content)
        # è¯†åˆ«æ ‡é¢˜ï¼ˆå¦‚"ä¸‰ã€ç¼´è´¹è¯´æ˜"ï¼‰
        if re.match(r'^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€', cleaned.strip()):
            doc.metadata["is_header"] = True
        processed_docs.append(doc)
    
    # é€’å½’å­—ç¬¦åˆ‡åˆ†ï¼šchunk_size=500ï¼Œä¿ç•™æ®µè½å®Œæ•´æ€§
    text_splitter = RecursiveCharacterTextSplitter(
        chunk_size=500,
        chunk_overlap=50,
        separators=["\n\n", "\n", "ã€‚", "ï¼", "ï¼Ÿ", " ", ""],
        length_function=len,
        is_separator_regex=False
    )
    
    chunks = text_splitter.split_documents(processed_docs)
    
    # å¢å¼º metadataï¼šç»§æ‰¿ç« èŠ‚æ ‡é¢˜
    for chunk in chunks:
        # ç®€å•çš„ä¸Šä¸‹æ–‡å¢å¼ºï¼šå¦‚æœ chunk ä»¥"("å¼€å¤´ï¼Œå¯èƒ½æ¥ä¸Šä¸€æ®µ
        if chunk.page_content.startswith(("(", "ï¼ˆ", "[", "ã€")):
            chunk.metadata["context_hint"] = "continued"
    
    print(f"ğŸ“„ åŸå§‹æ–‡æ¡£é¡µæ•°ï¼š{len(documents)}")
    print(f"âœ‚ï¸ åˆ‡åˆ†å chunks æ•°ï¼š{len(chunks)}")
    print(f"ğŸ“Š å¹³å‡ chunk é•¿åº¦ï¼š{sum(len(c.page_content) for c in chunks)/len(chunks):.0f} å­—ç¬¦")
    
    return chunks
```

**æ­¥éª¤ 3ï¼šå‘é‡åŒ–ä¸å­˜å‚¨ï¼ˆ1.5hï¼‰**

åœ¨ `db/vector_store.py` ä¸­å®ç° Chroma å­˜å‚¨ï¼š

```python
from langchain_community.vectorstores import Chroma
from langchain_community.embeddings import HuggingFaceEmbeddings
import os

# ä½¿ç”¨ BGE-m3 æ¨¡å‹ï¼ˆä¸­æ–‡ä¼˜åŒ–ï¼‰
embeddings = HuggingFaceEmbeddings(
    model_name="BAAI/bge-m3",
    model_kwargs={'device': 'cpu'},  # æ—  GPU ç¯å¢ƒä½¿ç”¨ cpu
    encode_kwargs={'normalize_embeddings': True}  # å½’ä¸€åŒ–ä¾¿äºä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—
)

def create_vector_db(chunks, persist_dir="./chroma_db"):
    """åˆ›å»ºå¹¶æŒä¹…åŒ–å‘é‡æ•°æ®åº“"""
    
    # å¦‚æœå·²å­˜åœ¨åˆ™åŠ è½½ï¼Œå¦åˆ™åˆ›å»º
    if os.path.exists(persist_dir) and len(os.listdir(persist_dir)) > 0:
        print("ğŸ”„ åŠ è½½å·²å­˜åœ¨çš„å‘é‡æ•°æ®åº“...")
        vectordb = Chroma(
            persist_directory=persist_dir,
            embedding_function=embeddings
        )
    else:
        print("ğŸ”¨ åˆ›å»ºæ–°çš„å‘é‡æ•°æ®åº“...")
        vectordb = Chroma.from_documents(
            documents=chunks,
            embedding=embeddings,
            persist_directory=persist_dir,
            collection_metadata={"hnsw:space": "cosine"}  # ä½¿ç”¨ä½™å¼¦è·ç¦»
        )
        vectordb.persist()
    
    return vectordb

def hybrid_search(vectordb, query: str, k: int = 5):
    """
    æ··åˆæ£€ç´¢ï¼šè¯­ä¹‰æ£€ç´¢ + å…³é”®è¯è¿‡æ»¤
    """
    # 1. è¯­ä¹‰æ£€ç´¢
    semantic_results = vectordb.similarity_search_with_score(query, k=k*2)
    
    # 2. å…³é”®è¯åŒ¹é…å¼ºåŒ–ï¼ˆç®€å•å®ç°ï¼šåŒ…å«å…³é”®è¯çš„ boostï¼‰
    keywords = extract_keywords(query)  # ç®€å•åˆ†è¯æå–å…³é”®è¯
    boosted_results = []
    
    for doc, score in semantic_results:
        # åŸå§‹åˆ†æ•°æ˜¯è·ç¦»ï¼ˆè¶Šå°è¶Šå¥½ï¼‰ï¼Œè½¬ä¸ºç›¸ä¼¼åº¦ï¼ˆè¶Šå¤§è¶Šå¥½ï¼‰
        similarity = 1 - score
        
        # å…³é”®è¯åŒ¹é…åŠ åˆ†
        content_lower = doc.page_content.lower()
        keyword_boost = sum(0.1 for kw in keywords if kw in content_lower)
        final_score = similarity + keyword_boost
        
        boosted_results.append((doc, final_score))
    
    # æŒ‰æœ€ç»ˆåˆ†æ•°æ’åºå¹¶è¿”å›å‰ k ä¸ª
    boosted_results.sort(key=lambda x: x[1], reverse=True)
    return boosted_results[:k]

def extract_keywords(text: str):
    """ç®€å•å…³é”®è¯æå–ï¼ˆå®é™…å¯ç”¨ jiebaï¼‰"""
    # é’ˆå¯¹æ ¡å›­åœºæ™¯çš„å…³é”®è¯åº“
    key_terms = ["å­¦è´¹", "å®¿èˆ", "ä¸€å¡é€š", "å†›è®­", "å›¾ä¹¦é¦†", "æŠ¥åˆ°", "æ¡£æ¡ˆ", "æˆ·å£"]
    return [term for term in key_terms if term in text]
```

**æ­¥éª¤ 4ï¼šRAG Agent é›†æˆï¼ˆ1.5hï¼‰**

åœ¨ `agents/day2_rag_agent.py` ä¸­ç»“åˆ Day 1 çš„ Agentï¼š

```python
from langgraph.prebuilt import create_react_agent
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage
from langchain.tools import tool
from db.vector_store import create_vector_db, hybrid_search
from db.rag_loader import load_and_split_handbook
import os

# åˆå§‹åŒ–å‘é‡åº“ï¼ˆå…¨å±€åŠ è½½ä¸€æ¬¡ï¼‰
print("ğŸ”„ åˆå§‹åŒ– RAG ç³»ç»Ÿ...")
chunks = load_and_split_handbook("data/æ–°ç”ŸæŠ¥åˆ°æ‰‹å†Œ.pdf")
vectordb = create_vector_db(chunks)

@tool
def query_handbook(question: str) -> str:
    """
    æŸ¥è¯¢ã€Šæ–°ç”ŸæŠ¥åˆ°æ‰‹å†Œã€‹è·å–å®˜æ–¹ä¿¡æ¯
    Args:
        question: å­¦ç”Ÿå…³äºæŠ¥åˆ°æµç¨‹ã€ç¼´è´¹ã€å®¿èˆç­‰çš„é—®é¢˜
    """
    # æ··åˆæ£€ç´¢
    results = hybrid_search(vectordb, question, k=3)
    
    if not results:
        return "æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯ï¼Œå»ºè®®è”ç³»å­¦å·¥å¤„å’¨è¯¢ã€‚"
    
    # ç»„è£…ä¸Šä¸‹æ–‡
    context = "\n\n".join([
        f"[ç›¸å…³åº¦: {score:.2f}] {doc.page_content}" 
        for doc, score in results
    ])
    
    return f"æ ¹æ®æŠ¥åˆ°æ‰‹å†ŒæŸ¥è¯¢ç»“æœï¼š\n{context}"

# å·¥å…·åˆ—è¡¨ï¼ˆå¤ç”¨ Day1 çš„å·¥å…· + RAG å·¥å…·ï¼‰
from agents.tools.campus_info import (
    query_campus_library_status, 
    query_tuition_payment
)

tools = [query_handbook, query_campus_library_status, query_tuition_payment]

model = ChatOpenAI(
    model="gpt-4o-mini",
    temperature=0,
    base_url=os.getenv("OPENAI_BASE_URL"),
    api_key=os.getenv("OPENAI_API_KEY")
)

rag_agent = create_react_agent(model, tools)

def ask_about_registration(question: str):
    """å¯¹å¤–æ¥å£ï¼šè¯¢é—®æŠ¥åˆ°ç›¸å…³é—®é¢˜"""
    response = rag_agent.invoke({
        "messages": [HumanMessage(content=question)]
    })
    return response["messages"][-1].content

# æµ‹è¯•
if __name__ == "__main__":
    test_questions = [
        "æŠ¥åˆ°éœ€è¦å¸¦å“ªäº›ææ–™ï¼Ÿ",
        "å­¦è´¹æœ€æ™šä»€ä¹ˆæ—¶å€™äº¤ï¼Ÿ",
        "å®¿èˆæ˜¯æ€ä¹ˆåˆ†é…çš„ï¼Ÿ"
    ]
    
    for q in test_questions:
        print(f"\nğŸ‘¤ é—®é¢˜ï¼š{q}")
        print(f"ğŸ¤– å›ç­”ï¼š{ask_about_registration(q)}")
        print("-" * 50)
```

**æ­¥éª¤ 5ï¼šæ£€ç´¢æ•ˆæœè¯„æµ‹ï¼ˆ1hï¼‰**

åœ¨ `tests/test_rag.py` ä¸­å®ç°è¯„ä¼°ï¼š

```python
def evaluate_retrieval():
    """è¯„æµ‹æ£€ç´¢å‡†ç¡®ç‡"""
    test_cases = [
        {
            "query": "æ¡£æ¡ˆæ€ä¹ˆè½¬è¿‡æ¥ï¼Ÿ",
            "expected_keywords": ["æ¡£æ¡ˆ", "è½¬é€’", "äººäº‹"],
            "description": "æ¡£æ¡ˆè½¬é€’ç›¸å…³é—®é¢˜"
        },
        {
            "query": "å¼€å­¦è¦å†›è®­å¤šä¹…ï¼Ÿ",
            "expected_keywords": ["å†›è®­", "ä¸¤å‘¨", "14å¤©"],
            "description": "å†›è®­æ—¶é•¿é—®é¢˜"
        }
    ]
    
    scores = []
    for case in test_cases:
        results = hybrid_search(vectordb, case["query"], k=3)
        content = " ".join([doc.page_content for doc, _ in results])
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«é¢„æœŸå…³é”®è¯
        hit_count = sum(1 for kw in case["expected_keywords"] if kw in content)
        score = hit_count / len(case["expected_keywords"])
        scores.append(score)
        
        print(f"{'âœ…' if score > 0.5 else 'âŒ'} {case['description']}: {score:.0%}")
    
    print(f"\nğŸ“Š å¹³å‡å¬å›ç‡ï¼š{sum(scores)/len(scores):.0%}")
```

**æ­¥éª¤ 6ï¼šæäº¤ï¼ˆ0.5hï¼‰**

```bash
git add .
git commit -m "feat(day2): å®ç° RAG æŠ¥åˆ°æ‰‹å†Œé—®ç­”ç³»ç»Ÿ
- å®Œæˆ PDF åŠ è½½ä¸æ™ºèƒ½åˆ‡åˆ†ï¼ˆRecursiveCharacterTextSplitterï¼‰
- é›†æˆ BGE-m3 åµŒå…¥æ¨¡å‹ä¸ Chroma å‘é‡åº“
- å®ç°æ··åˆæ£€ç´¢ï¼ˆè¯­ä¹‰+å…³é”®è¯ï¼‰
- ä¸ Day1 Agent é›†æˆï¼Œæ”¯æŒæ‰‹å†ŒæŸ¥è¯¢å·¥å…·"
git push origin feature/day2-rag-system
```

#### å…­ã€è€ƒæ ¸æ–¹æ³•ï¼ˆé‡åŒ–è¯„åˆ†ï¼Œ10 åˆ†ï¼‰

| è€ƒæ ¸é¡¹ | åˆ†å€¼ | è¯„åˆ†æ ‡å‡† |
|-------|------|---------|
| **æ–‡æ¡£åˆ‡åˆ†ç­–ç•¥** | 2 åˆ† | ä½¿ç”¨ RecursiveCharacterTextSplitterï¼Œchunk_size åˆç†ï¼ˆ300-800ï¼‰ï¼Œä¿ç•™ä¸Šä¸‹æ–‡ |
| **å‘é‡åŒ–æ­£ç¡®** | 2 åˆ† | ä½¿ç”¨ BGE-m3 æ¨¡å‹ï¼Œæ­£ç¡®æŒä¹…åŒ– Chroma æ•°æ®åº“ï¼Œmetadata åŒ…å«é¡µç ä¿¡æ¯ |
| **æ··åˆæ£€ç´¢å®ç°** | 3 åˆ† | åŒæ—¶å®ç°è¯­ä¹‰æ£€ç´¢ä¸å…³é”®è¯è¿‡æ»¤ï¼Œèƒ½æ ¹æ®å…³é”®è¯ï¼ˆå¦‚"å­¦è´¹"ï¼‰ç²¾ç¡®å®šä½ |
| **RAG æ•ˆæœ** | 2 åˆ† | å›ç­”åŒ…å«å¼•ç”¨æ¥æºï¼ˆé¡µç æˆ–ç« èŠ‚ï¼‰ï¼Œé’ˆå¯¹"æŠ¥åˆ°æµç¨‹"ç±»é—®é¢˜å‡†ç¡®ç‡åœ¨ 80% ä»¥ä¸Š |
| **ä»£ç ä¸æ–‡æ¡£** | 1 åˆ† | æäº¤æµ‹è¯•ç”¨ä¾‹ä¸è¯„æµ‹ç»“æœï¼ŒREADME è¯´æ˜å¦‚ä½•æ·»åŠ æ–°çš„ PDF æ–‡æ¡£ |

---

## Day 3ï¼šçŸ¥è¯†å›¾è°±ä¸ Neo4j å»ºæ¨¡

#### ä¸€ã€å‰æœŸçŸ¥è¯†ï¼ˆè¯¾å‰é¢„ä¹ ï¼Œ1hï¼‰

**å‚è€ƒèµ„æ–™**ï¼š
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/å›¾æ•°æ®åº“åŸºç¡€.md` - èŠ‚ç‚¹ã€å…³ç³»ã€å±æ€§å›¾æ¨¡å‹
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/CypheræŸ¥è¯¢è¯­è¨€.md` - MATCHã€WHEREã€CREATE è¯­æ³•

1. **å±æ€§å›¾æ¨¡å‹**ï¼šèŠ‚ç‚¹ï¼ˆEntityï¼‰ã€å…³ç³»ï¼ˆRelationï¼‰ã€å±æ€§ï¼ˆPropertyï¼‰çš„æ¦‚å¿µï¼›
2. **Cypher åŸºç¡€**ï¼š`MATCH (n:Student)-[:BELONGS_TO]->(d:Dormitory) RETURN n,d`ï¼›
3. **Text-to-Cypher**ï¼šå¦‚ä½•å°†è‡ªç„¶è¯­è¨€è½¬ä¸ºå›¾æŸ¥è¯¢è¯­å¥ï¼Œ**æ³¨å…¥æ”»å‡»é£é™©**ï¼ˆé‡ç‚¹ï¼‰ã€‚

#### äºŒã€å®éªŒç›®æ ‡

1. è®¾è®¡æ ¡å›­é¢†åŸŸæœ¬ä½“ï¼ˆOntologyï¼‰ï¼šå­¦ç”Ÿã€æ•™å¸ˆã€å®éªŒå®¤ã€è¯¾ç¨‹ã€å®¿èˆç­‰å®ä½“å…³ç³»ï¼›
2. å®ç°å®‰å…¨çš„ Text-to-Cypherï¼ˆé˜²æ­¢ Cypher æ³¨å…¥ï¼Œé™åˆ¶æŸ¥è¯¢ç±»å‹ä¸ºåªè¯»ï¼‰ï¼›
3. å®Œæˆå¤šè·³å…³ç³»æŸ¥è¯¢ï¼ˆå¦‚"æŸ¥è¯¢å¯¼å¸ˆæ‰€åœ¨å®éªŒå®¤çš„æ‰€æœ‰å­¦ç”Ÿ"ï¼‰ã€‚

#### ä¸‰ã€éš¾ç‚¹é‡ç‚¹

- **é‡ç‚¹**ï¼šå›¾å»ºæ¨¡ï¼ˆå¦‚ä½•é¿å…è¶…çº§èŠ‚ç‚¹ï¼‰ã€Cypher æŸ¥è¯¢ä¼˜åŒ–ï¼›
- **éš¾ç‚¹**ï¼šText-to-Cypher çš„å®‰å…¨æ€§æ§åˆ¶ï¼ˆç¦æ­¢ DROPã€DELETEï¼Œåªå…è®¸ MATCHï¼‰ã€‚

#### å››ã€çŸ¥è¯†åŸºç¡€

- **å¿…å¤‡**ï¼šSQL æŸ¥è¯¢åŸºç¡€ï¼Œç†è§£ JOIN æ“ä½œï¼ˆå¯¹æ¯”å›¾éå†ï¼‰ï¼›
- **å¯é€‰**ï¼šäº†è§£ RDFã€OWL ç­‰è¯­ä¹‰ç½‘æŠ€æœ¯ã€‚

#### äº”ã€å®éªŒæ­¥éª¤ï¼ˆ8hï¼Œå« 2h ç†è®ºè®²è§£ï¼‰

**é˜¶æ®µ 1ï¼šç†è®ºè®²è§£ï¼ˆ2hï¼‰**

1. **çŸ¥è¯†å›¾è°± vs å‘é‡åº“**ï¼ˆ20minï¼‰ï¼šç»“æ„åŒ–çŸ¥è¯†ï¼ˆç²¾ç¡®å…³ç³»ï¼‰vs éç»“æ„åŒ–æ–‡æœ¬ï¼ˆè¯­ä¹‰æ¨¡ç³Šï¼‰çš„äº’è¡¥ï¼›
2. **Neo4j å›¾å»ºæ¨¡**ï¼ˆ40minï¼‰ï¼š  
   - èŠ‚ç‚¹æ ‡ç­¾è®¾è®¡ï¼ˆ:Student, :Teacher, :Labï¼‰  
   - å…³ç³»ç±»å‹è®¾è®¡ï¼ˆ:ADVISES, :BELONGS_TO, :LIVES_INï¼‰  
   - é¿å…è¶…çº§èŠ‚ç‚¹ï¼ˆçƒ­é—¨æ•™å¸ˆè¿æ¥è¿‡å¤šå­¦ç”Ÿï¼‰  
3. **Cypher æ³¨å…¥é˜²å¾¡**ï¼ˆ30minï¼‰ï¼š  
   - å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆParameterized Queriesï¼‰  
   - LLM æç¤ºå·¥ç¨‹é™åˆ¶ï¼ˆåªç”Ÿæˆ MATCH è¯­å¥ï¼‰  
   - æŸ¥è¯¢ç™½åå•éªŒè¯ï¼ˆæ­£åˆ™è¿‡æ»¤å±é™©å…³é”®å­—ï¼‰  
4. **Text-to-Cypher Pipeline**ï¼ˆ30minï¼‰ï¼šSchema æè¿° â†’ Few-shot ç¤ºä¾‹ â†’ Cypher ç”Ÿæˆ â†’ æ‰§è¡Œ â†’ ç»“æœè§£é‡Šã€‚

**é˜¶æ®µ 2ï¼šå®æ“è½åœ°ï¼ˆ6hï¼‰**

**æ­¥éª¤ 1ï¼šç¯å¢ƒé…ç½®ï¼ˆ0.5hï¼‰**

æ³¨å†Œ Neo4j Auraï¼ˆå…è´¹äº‘ç«¯å®ä¾‹ï¼‰æˆ–ä½¿ç”¨æœ¬åœ° Dockerï¼š

```bash
git checkout -b feature/day3-knowledge-graph
uv pip install neo4j langchain-community -i https://pypi.tuna.tsinghua.edu.cn/simple
```

è®°å½•è¿æ¥ä¿¡æ¯ï¼š`NEO4J_URI`, `NEO4J_USER`, `NEO4J_PASSWORD`ã€‚

**æ­¥éª¤ 2ï¼šæœ¬ä½“è®¾è®¡ä¸æ•°æ®å¯¼å…¥ï¼ˆ1.5hï¼‰**

åœ¨ `db/neo4j_schema.py` ä¸­å®šä¹‰ Schema å¹¶å¯¼å…¥æ¨¡æ‹Ÿæ•°æ®ï¼š

```python
from neo4j import GraphDatabase
import os

class CampusGraph:
    def __init__(self):
        self.driver = GraphDatabase.driver(
            os.getenv("NEO4J_URI"),
            auth=(os.getenv("NEO4J_USER"), os.getenv("NEO4J_PASSWORD"))
        )
    
    def close(self):
        self.driver.close()
    
    def init_schema(self):
        """åˆå§‹åŒ–æ ¡å›­çŸ¥è¯†å›¾è°± Schema ä¸æ¨¡æ‹Ÿæ•°æ®"""
        with self.driver.session() as session:
            # æ¸…ç†ç°æœ‰æ•°æ®ï¼ˆä»…å¼€å‘ç¯å¢ƒä½¿ç”¨ï¼‰
            session.run("MATCH (n) DETACH DELETE n")
            
            # åˆ›å»ºçº¦æŸ
            session.run("CREATE CONSTRAINT student_id IF NOT EXISTS FOR (s:Student) REQUIRE s.id IS UNIQUE")
            session.run("CREATE CONSTRAINT teacher_id IF NOT EXISTS FOR (t:Teacher) REQUIRE t.id IS UNIQUE")
            
            # åˆ›å»ºèŠ‚ç‚¹å’Œå…³ç³»ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
            cypher_query = """
            // åˆ›å»ºæ•™å¸ˆ
            CREATE (t1:Teacher {id: 'T001', name: 'å¼ æ•™æˆ', field: 'äººå·¥æ™ºèƒ½', title: 'æ•™æˆ'})
            CREATE (t2:Teacher {id: 'T002', name: 'ç‹å‰¯æ•™æˆ', field: 'è½¯ä»¶å·¥ç¨‹', title: 'å‰¯æ•™æˆ'})
            
            // åˆ›å»ºå®éªŒå®¤
            CREATE (l1:Lab {id: 'L001', name: 'æ™ºèƒ½ç³»ç»Ÿå®éªŒå®¤', building: 'ç§‘æŠ€æ¥¼'})
            CREATE (l2:Lab {id: 'L002', name: 'è½¯ä»¶å·¥ç¨‹å®éªŒå®¤', building: 'ä¿¡æ¯æ¥¼'})
            
            // åˆ›å»ºå­¦ç”Ÿ
            CREATE (s1:Student {id: '2024001', name: 'ææ˜', major: 'è®¡ç®—æœºç§‘å­¦', grade: '2024'})
            CREATE (s2:Student {id: '2024002', name: 'ç‹èŠ³', major: 'è½¯ä»¶å·¥ç¨‹', grade: '2024'})
            CREATE (s3:Student {id: '2024003', name: 'å¼ ä¼Ÿ', major: 'è®¡ç®—æœºç§‘å­¦', grade: '2024'})
            
            // åˆ›å»ºå®¿èˆ
            CREATE (d1:Dormitory {id: 'A1-301', building: 'A1', room: '301', type: 'å››äººé—´'})
            CREATE (d2:Dormitory {id: 'A2-205', building: 'A2', room: '205', type: 'å…­äººé—´'})
            
            // åˆ›å»ºè¯¾ç¨‹
            CREATE (c1:Course {id: 'C001', name: 'Pythonç¼–ç¨‹', credits: 3})
            CREATE (c2:Course {id: 'C002', name: 'æ•°æ®ç»“æ„', credits: 4})
            
            // å»ºç«‹å…³ç³»
            CREATE (t1)-[:SUPERVISES]->(s1)
            CREATE (t1)-[:SUPERVISES]->(s3)
            CREATE (t2)-[:SUPERVISES]->(s2)
            
            CREATE (t1)-[:BELONGS_TO]->(l1)
            CREATE (t2)-[:BELONGS_TO]->(l2)
            CREATE (s1)-[:BELONGS_TO]->(l1)
            CREATE (s3)-[:BELONGS_TO]->(l1)
            
            CREATE (s1)-[:LIVES_IN]->(d1)
            CREATE (s2)-[:LIVES_IN]->(d2)
            CREATE (s3)-[:LIVES_IN]->(d1)
            
            CREATE (s1)-[:ENROLLED_IN {semester: '2024-1'}]->(c1)
            CREATE (s2)-[:ENROLLED_IN {semester: '2024-1'}]->(c1)
            CREATE (s3)-[:ENROLLED_IN {semester: '2024-1'}]->(c2)
            """
            session.run(cypher_query)
            print("âœ… çŸ¥è¯†å›¾è°±åˆå§‹åŒ–å®Œæˆ")

if __name__ == "__main__":
    graph = CampusGraph()
    graph.init_schema()
    graph.close()
```

**æ­¥éª¤ 3ï¼šå®‰å…¨æŸ¥è¯¢å±‚ï¼ˆ1.5hï¼‰**

åœ¨ `db/neo4j_client.py` ä¸­å®ç°å®‰å…¨çš„ Text-to-Cypherï¼š

```python
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
import re
import os

class SecureGraphClient:
    def __init__(self, neo4j_driver):
        self.driver = neo4j_driver
        self.llm = ChatOpenAI(
            model="gpt-4o-mini",
            temperature=0,
            base_url=os.getenv("OPENAI_BASE_URL"),
            api_key=os.getenv("OPENAI_API_KEY")
        )
        
        # å±é™©æ“ä½œé»‘åå•
        self.dangerous_keywords = [
            r'\bdrop\b', r'\bdelete\b', r'\bremove\b', 
            r'\bset\b', r'\bcreate\b', r'\bmerge\b',
            r'\bdetach\b', r'\bforeach\b', r'\bload\b',
            r';.*drop', r';.*delete'  # é˜²æ­¢å¤šè¯­å¥æ³¨å…¥
        ]
    
    def is_safe_query(self, cypher: str) -> bool:
        """éªŒè¯ Cypher æŸ¥è¯¢å®‰å…¨æ€§"""
        lower_cypher = cypher.lower()
        for pattern in self.dangerous_keywords:
            if re.search(pattern, lower_cypher):
                return False
        
        # åªå…è®¸ä»¥ MATCH å¼€å¤´ï¼ˆåªè¯»ï¼‰
        if not lower_cypher.strip().startswith('match'):
            return False
            
        return True
    
    def text_to_cypher(self, question: str) -> str:
        """å°†è‡ªç„¶è¯­è¨€è½¬ä¸º Cypherï¼ˆå¸¦å®‰å…¨é˜²æŠ¤ï¼‰"""
        
        schema_desc = """
        èŠ‚ç‚¹ç±»å‹ï¼š
        - Student: id, name, major, grade
        - Teacher: id, name, field, title
        - Lab: id, name, building
        - Dormitory: id, building, room, type
        - Course: id, name, credits
        
        å…³ç³»ç±»å‹ï¼š
        - (Teacher)-[:SUPERVISES]->(Student): å¯¼å¸ˆæŒ‡å¯¼
        - (Teacher|Student)-[:BELONGS_TO]->(Lab): æ‰€å±å®éªŒå®¤
        - (Student)-[:LIVES_IN]->(Dormitory): ä½å®¿
        - (Student)-[:ENROLLED_IN]->(Course): é€‰è¯¾
        """
        
        prompt = ChatPromptTemplate.from_messages([
            ("system", f"""ä½ æ˜¯ä¸€ä¸ª Neo4j Cypher æŸ¥è¯¢ç”ŸæˆåŠ©æ‰‹ã€‚
ä¸¥æ ¼éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š
1. åªç”Ÿæˆ MATCH æŸ¥è¯¢è¯­å¥ï¼ˆåªè¯»ï¼‰ï¼Œç¦æ­¢ç”Ÿæˆ CREATE/DELETE/DROP/SET/REMOVE/MERGE
2. ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆ$parameterï¼‰é˜²æ­¢æ³¨å…¥
3. æŸ¥è¯¢å¿…é¡»åŸºäºä»¥ä¸‹ Schemaï¼š{schema_desc}
4. å¦‚æœé—®é¢˜æ¶‰åŠä¿®æ”¹æ•°æ®ï¼Œæ‹’ç»ç”Ÿæˆå¹¶è¿”å›ï¼šUNSAFE_QUERY
5. åªè¿”å› Cypher ä»£ç ï¼Œä¸è¦è§£é‡Š"""),
            ("human", "é—®é¢˜ï¼š{question}\nç”Ÿæˆ Cypher æŸ¥è¯¢ï¼š")
        ])
        
        chain = prompt | self.llm
        response = chain.invoke({"question": question})
        cypher = response.content.strip()
        
        # æ¸…ç†ä»£ç å—æ ‡è®°
        cypher = re.sub(r'```cypher|```', '', cypher).strip()
        
        return cypher
    
    def query(self, question: str):
        """å®‰å…¨çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢æ¥å£"""
        try:
            # 1. ç”Ÿæˆ Cypher
            cypher = self.text_to_cypher(question)
            print(f"ğŸ¤– ç”Ÿæˆçš„ Cypherï¼š{cypher}")
            
            # 2. å®‰å…¨æ£€æŸ¥
            if cypher == "UNSAFE_QUERY" or not self.is_safe_query(cypher):
                return {"error": "æŸ¥è¯¢åŒ…å«å±é™©æ“ä½œï¼Œå·²æ‹¦æˆª", "cypher": cypher}
            
            # 3. æ‰§è¡ŒæŸ¥è¯¢ï¼ˆåªè¯»æ¨¡å¼ï¼‰
            with self.driver.session() as session:
                result = session.run(cypher)
                records = [dict(record) for record in result]
                return {
                    "cypher": cypher,
                    "results": records,
                    "count": len(records)
                }
                
        except Exception as e:
            return {"error": str(e), "cypher": cypher if 'cypher' in locals() else None}
    
    def get_student_network(self, student_name: str):
        """ç‰¹å®šæŸ¥è¯¢ï¼šè·å–å­¦ç”Ÿçš„å…³ç³»ç½‘ç»œï¼ˆå¯¼å¸ˆã€å®¤å‹ã€åŒå®éªŒå®¤åŒå­¦ï¼‰"""
        query = """
        MATCH (s:Student {name: $name})-[:SUPERVISES*0..1]-(t:Teacher)
        OPTIONAL MATCH (s)-[:LIVES_IN]->(d:Dormitory)<-[:LIVES_IN]-(roommate:Student)
        OPTIONAL MATCH (s)-[:BELONGS_TO]->(l:Lab)<-[:BELONGS_TO]-(colleague:Student)
        RETURN s.name as student, 
               t.name as supervisor, 
               collect(DISTINCT roommate.name) as roommates,
               collect(DISTINCT colleague.name) as lab_colleagues,
               l.name as lab
        """
        with self.driver.session() as session:
            result = session.run(query, name=student_name)
            return [dict(record) for record in result]
```

**æ­¥éª¤ 4ï¼šå·¥å…·é›†æˆï¼ˆ1.5hï¼‰**

åœ¨ `agents/tools/kg_tools.py` ä¸­å°è£…ä¸º Agent å·¥å…·ï¼š

```python
from langchain.tools import tool
from db.neo4j_client import SecureGraphClient
from db.neo4j_schema import CampusGraph

# åˆå§‹åŒ–
graph = CampusGraph()
kg_client = SecureGraphClient(graph.driver)

@tool
def query_campus_kg(question: str) -> str:
    """
    æŸ¥è¯¢æ ¡å›­çŸ¥è¯†å›¾è°±ï¼Œè·å–å­¦ç”Ÿã€æ•™å¸ˆã€å®éªŒå®¤ç­‰å…³ç³»ä¿¡æ¯ã€‚
    é€‚ç”¨äºï¼šå¯¼å¸ˆæŸ¥è¯¢ã€å®éªŒå®¤æˆå‘˜ã€å®¿èˆåˆ†é…ã€è¯¾ç¨‹é€‰ä¿®ç­‰å…³ç³»å‹é—®é¢˜ã€‚
    Args:
        question: è‡ªç„¶è¯­è¨€é—®é¢˜ï¼Œå¦‚"å¼ æ•™æˆçš„å­¦ç”Ÿæœ‰å“ªäº›ï¼Ÿ"
    """
    result = kg_client.query(question)
    
    if "error" in result:
        return f"æŸ¥è¯¢å¤±è´¥ï¼š{result['error']}"
    
    if result["count"] == 0:
        return "æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯ã€‚"
    
    # æ ¼å¼åŒ–ç»“æœ
    formatted = f"æŸ¥è¯¢è¯­å¥ï¼š{result['cypher']}\n\næŸ¥è¯¢ç»“æœï¼ˆå…±{result['count']}æ¡ï¼‰ï¼š\n"
    for i, record in enumerate(result["results"][:5], 1):  # æœ€å¤šæ˜¾ç¤º5æ¡
        formatted += f"{i}. {record}\n"
    
    return formatted

@tool
def get_student_social_network(student_name: str) -> str:
    """
    è·å–å­¦ç”Ÿçš„ç¤¾äº¤å…³ç³»ç½‘ç»œï¼ˆå¯¼å¸ˆã€å®¤å‹ã€åŒå®éªŒå®¤åŒå­¦ï¼‰
    Args:
        student_name: å­¦ç”Ÿå§“åï¼Œå¦‚"ææ˜"
    """
    results = kg_client.get_student_network(student_name)
    
    if not results:
        return f"æœªæ‰¾åˆ°å­¦ç”Ÿ {student_name} çš„ä¿¡æ¯"
    
    info = results[0]
    return f"""
    å­¦ç”Ÿï¼š{info['student']}
    å¯¼å¸ˆï¼š{info['supervisor']}
    æ‰€åœ¨å®éªŒå®¤ï¼š{info['lab']}
    å®¤å‹ï¼š{', '.join(info['roommates']) if info['roommates'] else 'æ— '}
    å®éªŒå®¤åŒå­¦ï¼š{', '.join(info['lab_colleagues']) if info['lab_colleagues'] else 'æ— '}
    """
```

**æ­¥éª¤ 5ï¼šè”é‚¦æŸ¥è¯¢å®éªŒï¼ˆ1hï¼‰**

ç»“åˆ Day 2 çš„ RAGï¼Œå®ç°"å‘é‡æ£€ç´¢ + å›¾è°±æŸ¥è¯¢"çš„è”é‚¦æŸ¥è¯¢ï¼š

```python
def hybrid_kg_rag_query(question: str):
    """
    æ··åˆæŸ¥è¯¢ï¼šå…ˆå‘é‡æ£€ç´¢è·å–å®ä½“ï¼Œå†å›¾è°±æŸ¥è¯¢è·å–å…³ç³»
    ç¤ºä¾‹ï¼š"ææ˜çš„å¯¼å¸ˆæ˜¯è°ï¼Ÿ" 
    â†’ 1. RAGè¯†åˆ«"ææ˜"æ˜¯å­¦ç”Ÿå®ä½“
    â†’ 2. KGæŸ¥è¯¢(Supervisor)å…³ç³»
    """
    # ç®€åŒ–å®ç°ï¼šå…ˆæå–å®ä½“ï¼ˆå¯ç”¨NERæˆ–ç®€å•å…³é”®è¯åŒ¹é…ï¼‰
    # å®é™…åº”ç”¨ä¸­å¯ä½¿ç”¨ LLM æå–å®ä½“
    if "ææ˜" in question:
        return kg_client.get_student_network("ææ˜")
    # ... å…¶ä»–å®ä½“è¯†åˆ«é€»è¾‘
```

**æ­¥éª¤ 6ï¼šæäº¤ï¼ˆ0.5hï¼‰**

```bash
git add .
git commit -m "feat(day3): å®ç° Neo4j çŸ¥è¯†å›¾è°±ä¸å®‰å…¨æŸ¥è¯¢
- è®¾è®¡æ ¡å›­é¢†åŸŸæœ¬ä½“ï¼ˆStudent/Teacher/Lab/Dormitory/Courseï¼‰
- å®ç°å®‰å…¨çš„ Text-to-Cypherï¼ˆæ³¨å…¥é˜²æŠ¤+åªè¯»é™åˆ¶ï¼‰
- æ·»åŠ å…³ç³»ç½‘ç»œæŸ¥è¯¢å·¥å…·ï¼ˆå¯¼å¸ˆ/å®¤å‹/å®éªŒå®¤åŒå­¦ï¼‰
- æä¾›å¤šè·³æŸ¥è¯¢ç¤ºä¾‹ï¼ˆå¯¼å¸ˆçš„å­¦ç”Ÿï¼‰"
git push origin feature/day3-knowledge-graph
```

#### å…­ã€è€ƒæ ¸æ–¹æ³•ï¼ˆé‡åŒ–è¯„åˆ†ï¼Œ10 åˆ†ï¼‰

| è€ƒæ ¸é¡¹ | åˆ†å€¼ | è¯„åˆ†æ ‡å‡† |
|-------|------|---------|
| **å›¾å»ºæ¨¡åˆç†æ€§** | 2 åˆ† | èŠ‚ç‚¹æ ‡ç­¾ã€å…³ç³»ç±»å‹è®¾è®¡ç¬¦åˆæ ¡å›­åœºæ™¯ï¼Œæ— æ˜æ˜¾å†—ä½™ |
| **æ•°æ®å¯¼å…¥æ­£ç¡®** | 2 åˆ† | æˆåŠŸåˆ›å»ºèŠ‚ç‚¹å’Œå…³ç³»ï¼ŒåŒ…å«è‡³å°‘ 3 ç§å®ä½“ç±»å‹å’Œ 3 ç§å…³ç³»ç±»å‹ |
| **å®‰å…¨æœºåˆ¶** | 3 åˆ† | å®ç°å±é™©å…³é”®å­—è¿‡æ»¤ï¼ˆDELETE/DROP ç­‰ï¼‰ï¼Œåªå…è®¸ MATCH æŸ¥è¯¢ï¼Œä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ |
| **å¤šè·³æŸ¥è¯¢** | 2 åˆ† | å®ç°"æŸ¥è¯¢å¯¼å¸ˆæ‰€åœ¨å®éªŒå®¤çš„æ‰€æœ‰å­¦ç”Ÿ"ï¼ˆ2 è·³ä»¥ä¸Šï¼‰å¹¶è¿”å›æ­£ç¡®ç»“æœ |
| **å·¥å…·å°è£…** | 1 åˆ† | æ­£ç¡®å°è£…ä¸º LangChain Toolï¼Œå¯è¢« Agent è°ƒç”¨ï¼ŒåŒ…å«å‚æ•°æè¿° |

---

## Day 4ï¼šå·¥ä½œæµç¼–æ’ä¸ StateGraph

#### ä¸€ã€å‰æœŸçŸ¥è¯†ï¼ˆè¯¾å‰é¢„ä¹ ï¼Œ1hï¼‰

**å‚è€ƒèµ„æ–™**ï¼š
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/çŠ¶æ€æœºç†è®º.md` - FSM æœ‰é™çŠ¶æ€æœºåŸºç¡€
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/LangGraphæ ¸å¿ƒæ¦‚å¿µ.md` - Stateã€Nodeã€Edge

1. **çŠ¶æ€æœºåŸºç¡€**ï¼šçŠ¶æ€ï¼ˆStateï¼‰ã€è½¬ç§»ï¼ˆTransitionï¼‰ã€äº‹ä»¶ï¼ˆEventï¼‰ï¼›
2. **æŒä¹…åŒ–æ£€æŸ¥ç‚¹**ï¼šä¸ºä»€ä¹ˆéœ€è¦ Checkpointï¼Ÿæ•…éšœæ¢å¤ä¸å¯¹è¯å†å²çš„ä¿å­˜ï¼›
3. **æ¡ä»¶è¾¹ï¼ˆConditional Edgesï¼‰**ï¼šæ ¹æ®çŠ¶æ€å†³å®šä¸‹ä¸€æ­¥è·¯ç”±ã€‚

#### äºŒã€å®éªŒç›®æ ‡

1. è®¾è®¡å¹¶å®ç°"æ–°ç”ŸæŠ¥åˆ°æµç¨‹"çš„çŠ¶æ€æœºï¼ˆå’¨è¯¢â†’èº«ä»½éªŒè¯â†’ææ–™å®¡æ ¸â†’ç¼´è´¹ç¡®è®¤â†’å®Œæˆï¼‰ï¼›
2. æŒæ¡ StateGraph çš„æ„å»ºï¼šèŠ‚ç‚¹å®šä¹‰ã€è¾¹è¿æ¥ã€æ¡ä»¶è·¯ç”±ï¼›
3. å®ç°æŒä¹…åŒ–æ£€æŸ¥ç‚¹ï¼ˆCheckpointï¼‰ï¼Œæ”¯æŒå¯¹è¯ä¸­æ–­æ¢å¤ã€‚

#### ä¸‰ã€éš¾ç‚¹é‡ç‚¹

- **é‡ç‚¹**ï¼šState æ•°æ®ç»“æ„å®šä¹‰ï¼ˆTypedDictï¼‰ã€æ¡ä»¶è¾¹çš„è·¯ç”±é€»è¾‘ï¼›
- **éš¾ç‚¹**ï¼šå¤æ‚çŠ¶æ€çš„ç®¡ç†ï¼ˆå¦‚ä½•åœ¨ä¸åŒèŠ‚ç‚¹é—´ä¼ é€’ä¸Šä¸‹æ–‡ï¼‰ï¼Œæ£€æŸ¥ç‚¹çš„åºåˆ—åŒ–ä¸æ¢å¤ã€‚

#### å››ã€çŸ¥è¯†åŸºç¡€

- **å¿…å¤‡**ï¼šPython ç±»å‹æ³¨è§£ï¼ˆTypedDictï¼‰ã€å­—å…¸æ“ä½œï¼›
- **å¯é€‰**ï¼šäº†è§£ Redux æˆ– Vuex ç­‰å‰ç«¯çŠ¶æ€ç®¡ç†ï¼ˆæ¦‚å¿µç›¸é€šï¼‰ã€‚

#### äº”ã€å®éªŒæ­¥éª¤ï¼ˆ8hï¼Œå« 2h ç†è®ºè®²è§£ï¼‰

**é˜¶æ®µ 1ï¼šç†è®ºè®²è§£ï¼ˆ2hï¼‰**

1. **StateGraph æ¶æ„**ï¼ˆ40minï¼‰ï¼š  
   - Stateï¼ˆçŠ¶æ€å®¹å™¨ï¼‰ vs React çš„ State  
   - Nodeï¼ˆåŒæ­¥/å¼‚æ­¥å‡½æ•°ï¼‰  
   - Edgeï¼ˆæ™®é€šè¾¹ vs æ¡ä»¶è¾¹ï¼‰  
2. **æŠ¥åˆ°æµç¨‹å»ºæ¨¡**ï¼ˆ30minï¼‰ï¼š  
   - ç»˜åˆ¶çŠ¶æ€æµè½¬å›¾ï¼ˆStart â†’ InfoCollection â†’ Verification â†’ Payment â†’ Completed/Errorï¼‰  
   - è¯†åˆ«åˆ†æ”¯ç‚¹ï¼ˆææ–™é½å…¨ï¼Ÿç¼´è´¹æˆåŠŸï¼Ÿï¼‰  
3. **æŒä¹…åŒ–ä¸å®¹é”™**ï¼ˆ30minï¼‰ï¼š  
   - MemorySaver çš„ Thread ID æœºåˆ¶  
   - ä¸­æ–­æ¢å¤åœºæ™¯ï¼ˆç”¨æˆ·æ–­ç½‘åé‡è¿ï¼‰  
   - çŠ¶æ€ç‰ˆæœ¬æ§åˆ¶ï¼ˆæ£€æŸ¥ç‚¹é“¾ï¼‰

**é˜¶æ®µ 2ï¼šå®æ“è½åœ°ï¼ˆ6hï¼‰**

**æ­¥éª¤ 1ï¼šçŠ¶æ€å®šä¹‰ï¼ˆ1hï¼‰**

åœ¨ `agents/day4_state_graph.py` ä¸­å®šä¹‰æŠ¥åˆ°æµç¨‹çŠ¶æ€ï¼š

```python
from typing import TypedDict, Annotated, Optional, List
from langgraph.graph import StateGraph, END
from langgraph.checkpoint.memory import MemorySaver
from langchain_core.messages import BaseMessage, HumanMessage, AIMessage
import operator

# å®šä¹‰çŠ¶æ€ç»“æ„
class RegistrationState(TypedDict):
    # åŸºç¡€æ¶ˆæ¯ï¼ˆè‡ªåŠ¨èšåˆï¼‰
    messages: Annotated[List[BaseMessage], operator.add]
    
    # å­¦ç”Ÿä¿¡æ¯æ”¶é›†
    student_name: Optional[str]
    student_id: Optional[str]
    major: Optional[str]
    
    # æµç¨‹æ§åˆ¶
    current_step: str  # 'info_collection', 'verification', 'payment', 'completed'
    is_verified: bool
    documents_ready: bool
    payment_confirmed: bool
    
    # é”™è¯¯å¤„ç†
    error_message: Optional[str]
    retry_count: int

# åˆå§‹åŒ–å‡½æ•°
def init_state() -> RegistrationState:
    return {
        "messages": [],
        "student_name": None,
        "student_id": None,
        "major": None,
        "current_step": "info_collection",
        "is_verified": False,
        "documents_ready": False,
        "payment_confirmed": False,
        "error_message": None,
        "retry_count": 0
    }
```

**æ­¥éª¤ 2ï¼šèŠ‚ç‚¹å®ç°ï¼ˆ2hï¼‰**

```python
from langchain_openai import ChatOpenAI
import json

model = ChatOpenAI(model="gpt-4o-mini", temperature=0)

def info_collection_node(state: RegistrationState):
    """ä¿¡æ¯æ”¶é›†èŠ‚ç‚¹ï¼šæå–å­¦ç”ŸåŸºæœ¬ä¿¡æ¯"""
    messages = state["messages"]
    last_message = messages[-1].content if messages else ""
    
    # ä½¿ç”¨ LLM æå–å®ä½“
    prompt = f"""ä»ä»¥ä¸‹å¯¹è¯ä¸­æå–å­¦ç”Ÿä¿¡æ¯ï¼Œä»¥ JSON æ ¼å¼è¿”å›ï¼š
    å¯ç”¨å­—æ®µï¼šstudent_name, student_id, major
    å¦‚æœæŸä¸ªå­—æ®µæœªæåŠï¼Œä½¿ç”¨ nullã€‚
    
    å¯¹è¯ï¼š{last_message}
    
    æ³¨æ„ï¼šåªéœ€è¿”å› JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚
    ç¤ºä¾‹ï¼š{{"student_name": "å¼ ä¸‰", "student_id": "2024001", "major": null}}
    """
    
    response = model.invoke(prompt)
    try:
        extracted = json.loads(response.content)
        return {
            "student_name": extracted.get("student_name") or state["student_name"],
            "student_id": extracted.get("student_id") or state["student_id"],
            "major": extracted.get("major") or state["major"],
            "current_step": "verification",
            "messages": [AIMessage(content=f"å·²è®°å½•ä¿¡æ¯ï¼šå§“å {extracted.get('student_name')}, "
                                       f"å­¦å· {extracted.get('student_id')}")]
        }
    except:
        return {
            "error_message": "ä¿¡æ¯æå–å¤±è´¥ï¼Œè¯·é‡æ–°æä¾›",
            "retry_count": state["retry_count"] + 1,
            "current_step": "info_collection"
        }

def verification_node(state: RegistrationState):
    """èº«ä»½éªŒè¯èŠ‚ç‚¹ï¼šæ¨¡æ‹ŸéªŒè¯å­¦å·æ˜¯å¦å­˜åœ¨"""
    student_id = state["student_id"]
    
    # æ¨¡æ‹ŸéªŒè¯ï¼ˆå®é™…åº”æŸ¥è¯¢æ•°æ®åº“ï¼‰
    valid_ids = ["2024001", "2024002", "2024003"]
    
    if student_id in valid_ids:
        return {
            "is_verified": True,
            "current_step": "payment",
            "messages": [AIMessage(content=f"âœ… å­¦å· {student_id} éªŒè¯é€šè¿‡ï¼Œè¯·å®Œæˆç¼´è´¹ã€‚")]
        }
    else:
        return {
            "is_verified": False,
            "error_message": "å­¦å·ä¸å­˜åœ¨æˆ–å·²è¢«æ³¨å†Œ",
            "retry_count": state["retry_count"] + 1,
            "messages": [AIMessage(content="âŒ å­¦å·éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥å­¦å·æ˜¯å¦æ­£ç¡®ã€‚")]
        }

def payment_node(state: RegistrationState):
    """ç¼´è´¹ç¡®è®¤èŠ‚ç‚¹"""
    # è¿™é‡Œå¯ä»¥é›†æˆçœŸå®çš„æ”¯ä»˜ API æŸ¥è¯¢
    # æ¨¡æ‹Ÿï¼šè¯¢é—®ç”¨æˆ·æ˜¯å¦å·²å®Œæˆç¼´è´¹
    last_message = state["messages"][-1].content if state["messages"] else ""
    
    if "å·²ç¼´è´¹" in last_message or "å®Œæˆ" in last_message:
        return {
            "payment_confirmed": True,
            "current_step": "completed",
            "messages": [AIMessage(content="âœ… ç¼´è´¹ç¡®è®¤å®Œæˆï¼æŠ¥åˆ°æµç¨‹ç»“æŸï¼Œæ¬¢è¿æ¥åˆ°æ ¡å›­ï¼")]
        }
    else:
        return {
            "payment_confirmed": False,
            "current_step": "payment",
            "messages": [AIMessage(content="è¯·å‰å¾€è´¢åŠ¡å¤„æˆ–åœ¨çº¿å¹³å°å®Œæˆå­¦è´¹ç¼´çº³ï¼Œå®Œæˆåå›å¤'å·²ç¼´è´¹'ã€‚")]
        }

def error_handler_node(state: RegistrationState):
    """é”™è¯¯å¤„ç†èŠ‚ç‚¹"""
    if state["retry_count"] > 3:
        return {
            "messages": [AIMessage(content="é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œå·²è½¬æ¥äººå·¥å®¢æœã€‚")],
            "current_step": "error"
        }
    return {
        "messages": [AIMessage(content=f"å‘ç”Ÿé”™è¯¯ï¼š{state['error_message']}ï¼Œè¯·é‡è¯•ã€‚")],
        "current_step": "info_collection"
    }
```

**æ­¥éª¤ 3ï¼šæ¡ä»¶è¾¹ä¸å›¾æ„å»ºï¼ˆ1.5hï¼‰**

```python
def route_based_on_state(state: RegistrationState) -> str:
    """æ¡ä»¶è·¯ç”±å‡½æ•°"""
    if state.get("error_message") and state["retry_count"] > 0:
        if state["retry_count"] > 3:
            return "error_handler"
        return "info_collection"  # é‡è¯•
    
    step = state["current_step"]
    
    routing_map = {
        "info_collection": "verification",
        "verification": "payment" if state["is_verified"] else "error_handler",
        "payment": "completed" if state["payment_confirmed"] else "payment",
        "completed": END,
        "error": END
    }
    
    return routing_map.get(step, END)

# æ„å»ºå›¾
def create_registration_workflow():
    workflow = StateGraph(RegistrationState)
    
    # æ·»åŠ èŠ‚ç‚¹
    workflow.add_node("info_collection", info_collection_node)
    workflow.add_node("verification", verification_node)
    workflow.add_node("payment", payment_node)
    workflow.add_node("error_handler", error_handler_node)
    
    # æ·»åŠ è¾¹
    workflow.set_entry_point("info_collection")
    
    # æ¡ä»¶è¾¹ï¼šä»æ¯ä¸ªèŠ‚ç‚¹æ ¹æ®çŠ¶æ€è·¯ç”±
    workflow.add_conditional_edges(
        "info_collection",
        route_based_on_state,
        {
            "verification": "verification",
            "error_handler": "error_handler"
        }
    )
    
    workflow.add_conditional_edges(
        "verification",
        route_based_on_state,
        {
            "payment": "payment",
            "error_handler": "error_handler"
        }
    )
    
    workflow.add_conditional_edges(
        "payment",
        route_based_on_state,
        {
            "payment": "payment",  # è‡ªå¾ªç¯ç›´åˆ°ç¡®è®¤
            "completed": END,
            "error_handler": "error_handler"
        }
    )
    
    workflow.add_edge("error_handler", END)
    
    # æ·»åŠ æ£€æŸ¥ç‚¹ï¼ˆæŒä¹…åŒ–ï¼‰
    memory = MemorySaver()
    app = workflow.compile(checkpointer=memory)
    
    return app
```

**æ­¥éª¤ 4ï¼šä¸­æ–­æ¢å¤æ¼”ç¤ºï¼ˆ1hï¼‰**

```python
def demo_with_interrupt():
    """æ¼”ç¤ºæ£€æŸ¥ç‚¹ä¸ä¸­æ–­æ¢å¤"""
    app = create_registration_workflow()
    
    # é…ç½®ï¼šä½¿ç”¨ thread_id æ ‡è¯†å¯¹è¯çº¿ç¨‹
    config = {"configurable": {"thread_id": "student_2024001"}}
    
    print("ğŸ“ æ–°ç”ŸæŠ¥åˆ°æµç¨‹æ¼”ç¤ºï¼ˆè¾“å…¥ 'quit' é€€å‡ºï¼Œ'check' æŸ¥çœ‹çŠ¶æ€ï¼‰\n")
    
    while True:
        user_input = input("ğŸ‘¤ è¾“å…¥: ")
        
        if user_input == "quit":
            break
        elif user_input == "check":
            # æŸ¥çœ‹å½“å‰çŠ¶æ€ï¼ˆæ£€æŸ¥ç‚¹ï¼‰
            state = app.get_state(config)
            print(f"ğŸ“Š å½“å‰çŠ¶æ€ï¼š{state.values}")
            continue
        
        # è¿è¡Œå›¾
        events = app.stream(
            {"messages": [HumanMessage(content=user_input)]},
            config,
            stream_mode="values"
        )
        
        for event in events:
            if "messages" in event:
                print(f"ğŸ¤– Agent: {event['messages'][-1].content}")
            if "current_step" in event:
                print(f"   [å½“å‰æ­¥éª¤: {event['current_step']}]")

if __name__ == "__main__":
    demo_with_interrupt()
```

**æ­¥éª¤ 5ï¼šå¯è§†åŒ–ï¼ˆ0.5hï¼‰**

æ·»åŠ  Mermaid å›¾ç”Ÿæˆï¼š

```python
def visualize_workflow():
    """ç”Ÿæˆ Mermaid æµç¨‹å›¾ä»£ç """
    mermaid_code = """
    graph TD
        A[å¼€å§‹] --> B[ä¿¡æ¯æ”¶é›†]
        B --> C{éªŒè¯å­¦å·}
        C -->|æˆåŠŸ| D[ç¼´è´¹ç¡®è®¤]
        C -->|å¤±è´¥| E[é”™è¯¯å¤„ç†]
        D -->|æœªå®Œæˆ| D
        D -->|å·²å®Œæˆ| F[ç»“æŸ]
        E -->|é‡è¯•<3| B
        E -->|é‡è¯•>=3| F
    """
    print(mermaid_code)
    return mermaid_code
```

**æ­¥éª¤ 6ï¼šæäº¤ï¼ˆ0.5hï¼‰**

```bash
git add .
git commit -m "feat(day4): å®ç° StateGraph æŠ¥åˆ°æµç¨‹çŠ¶æ€æœº
- å®šä¹‰ RegistrationState çŠ¶æ€ç»“æ„ï¼ˆTypedDictï¼‰
- å®ç°4ä¸ªä¸šåŠ¡èŠ‚ç‚¹ï¼šä¿¡æ¯æ”¶é›†/èº«ä»½éªŒè¯/ç¼´è´¹ç¡®è®¤/é”™è¯¯å¤„ç†
- æ·»åŠ æ¡ä»¶è¾¹è·¯ç”±ä¸æ£€æŸ¥ç‚¹æŒä¹…åŒ–ï¼ˆMemorySaverï¼‰
- æ”¯æŒä¸­æ–­æ¢å¤ä¸çŠ¶æ€æŸ¥è¯¢"
git push origin feature/day4-state-graph
```

#### å…­ã€è€ƒæ ¸æ–¹æ³•ï¼ˆé‡åŒ–è¯„åˆ†ï¼Œ10 åˆ†ï¼‰

| è€ƒæ ¸é¡¹ | åˆ†å€¼ | è¯„åˆ†æ ‡å‡† |
|-------|------|---------|
| **çŠ¶æ€å®šä¹‰** | 2 åˆ† | ä½¿ç”¨ TypedDict å®šä¹‰çŠ¶æ€ï¼ŒåŒ…å«æ¶ˆæ¯å†å²ã€ä¸šåŠ¡å­—æ®µã€æ§åˆ¶å­—æ®µï¼Œä½¿ç”¨ Annotated èšåˆ |
| **èŠ‚ç‚¹å®ç°** | 2 åˆ† | è‡³å°‘ 3 ä¸ªä¸šåŠ¡èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹å‡½æ•°æ¥æ”¶ state è¿”å› dictï¼Œç¬¦åˆ StateGraph è§„èŒƒ |
| **æ¡ä»¶è·¯ç”±** | 3 åˆ† | ä½¿ç”¨ add_conditional_edges å®ç°åˆ†æ”¯é€»è¾‘ï¼ˆå¦‚éªŒè¯æˆåŠŸ/å¤±è´¥çš„ä¸åŒè·¯å¾„ï¼‰ |
| **æ£€æŸ¥ç‚¹** | 2 åˆ† | é›†æˆ MemorySaverï¼Œèƒ½é€šè¿‡ thread_id æ¢å¤çŠ¶æ€ï¼Œæ”¯æŒ get_state æŸ¥è¯¢ |
| **æµç¨‹å®Œæ•´æ€§** | 1 åˆ† | åŒ…å«å¼€å§‹èŠ‚ç‚¹ã€ç»“æŸèŠ‚ç‚¹ï¼ˆENDï¼‰ï¼Œæ— æ­»å¾ªç¯ï¼Œæäº¤ Mermaid æµç¨‹å›¾ |

---

## Day 5ï¼šä¸­é—´ä»¶ä½“ç³»ä¸å®‰å…¨åˆè§„

#### ä¸€ã€å‰æœŸçŸ¥è¯†ï¼ˆè¯¾å‰é¢„ä¹ ï¼Œ1hï¼‰

**å‚è€ƒèµ„æ–™**ï¼š
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/AIå®‰å…¨å¨èƒ.md` - Prompt Injectionã€PII æ³„éœ²
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/å†…å®¹è¿‡æ»¤æŠ€æœ¯.md` - æ•æ„Ÿè¯æ£€æµ‹ã€æ­£åˆ™è¡¨è¾¾å¼

1. **LLM å®‰å…¨é£é™©**ï¼šPrompt æ³¨å…¥ã€æ•°æ®æŠ•æ¯’ã€æ¨¡å‹çªƒå–ï¼›
2. **PIIï¼ˆä¸ªäººèº«ä»½ä¿¡æ¯ï¼‰**ï¼šå§“åã€èº«ä»½è¯å·ã€æ‰‹æœºå·ã€é“¶è¡Œå¡å·çš„è¯†åˆ«ä¸è„±æ•ï¼›
3. **ä¸­é—´ä»¶æ¨¡å¼**ï¼šæ´‹è‘±æ¨¡å‹ï¼ˆOnion Modelï¼‰ã€è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of Responsibilityï¼‰ã€‚

#### äºŒã€å®éªŒç›®æ ‡

1. å®ç°å››å±‚å®‰å…¨ä¸­é—´ä»¶ï¼šé¢„ç®—æ§åˆ¶ï¼ˆToken é™åˆ¶ï¼‰â†’ æ¶ˆæ¯æˆªæ–­ â†’ æ•æ„Ÿè¯è¿‡æ»¤ â†’ PII æ£€æµ‹ï¼›
2. å»ºç«‹å†…å®¹å®‰å…¨è¿‡æ»¤å±‚ï¼Œæ‹¦æˆªè¿æ³•ã€è¿è§„ã€è¿èƒŒæ ¡å›­ä»·å€¼è§‚çš„å†…å®¹ï¼›
3. è®¾è®¡å¯æ’æ‹”çš„ä¸­é—´ä»¶æ¶æ„ï¼Œæ”¯æŒåŠ¨æ€å¼€å¯/å…³é—­ç‰¹å®šå®‰å…¨å±‚ã€‚

#### ä¸‰ã€éš¾ç‚¹é‡ç‚¹

- **é‡ç‚¹**ï¼šä¸­é—´ä»¶é“¾çš„æ‰§è¡Œé¡ºåºè®¾è®¡ï¼ŒPII è¯†åˆ«çš„æ­£åˆ™ä¸æ¨¡å‹æ··åˆæ–¹æ¡ˆï¼›
- **éš¾ç‚¹**ï¼šå®‰å…¨ä¸ä½“éªŒçš„å¹³è¡¡ï¼ˆè¿‡åº¦è¿‡æ»¤å¯¼è‡´è¯¯ä¼¤ï¼Œè¿‡æ»¤ä¸è¶³å¯¼è‡´é£é™©ï¼‰ã€‚

#### å››ã€çŸ¥è¯†åŸºç¡€

- **å¿…å¤‡**ï¼šPython è£…é¥°å™¨ã€æ­£åˆ™è¡¨è¾¾å¼åŸºç¡€ï¼›
- **å¯é€‰**ï¼šäº†è§£ä»£ç†æ¨¡å¼ï¼ˆProxy Patternï¼‰ã€‚

#### äº”ã€å®éªŒæ­¥éª¤ï¼ˆ8hï¼Œå« 2h ç†è®ºè®²è§£ï¼‰

**é˜¶æ®µ 1ï¼šç†è®ºè®²è§£ï¼ˆ2hï¼‰**

1. **LLM åº”ç”¨å®‰å…¨æ¶æ„**ï¼ˆ40minï¼‰ï¼š  
   - è¾“å…¥ä¾§é˜²æŠ¤ï¼ˆè¾“å…¥éªŒè¯ã€Prompt æ³¨å…¥æ£€æµ‹ï¼‰  
   - æ¨¡å‹ä¾§é˜²æŠ¤ï¼ˆç³»ç»Ÿæç¤ºåŠ å›ºï¼‰  
   - è¾“å‡ºä¾§é˜²æŠ¤ï¼ˆå†…å®¹è¿‡æ»¤ã€PII è„±æ•ï¼‰  
2. **å››å±‚ä¸­é—´ä»¶è®¾è®¡**ï¼ˆ40minï¼‰ï¼š  
   - é¢„ç®—å±‚ï¼šToken æ¶ˆè€—ä¸Šé™ã€æˆæœ¬å‘Šè­¦  
   - æˆªæ–­å±‚ï¼šè¶…é•¿æ¶ˆæ¯æˆªæ–­ç­–ç•¥ï¼ˆå°¾éƒ¨æˆªæ–­ vs å¤´éƒ¨æˆªæ–­ï¼‰  
   - æ•æ„Ÿè¯å±‚ï¼šåŸºäº Trie æ ‘çš„é«˜æ•ˆåŒ¹é…ï¼Œæ”¯æŒé€šé…ç¬¦  
   - PII å±‚ï¼šæ­£åˆ™ + NER æ¨¡å‹è¯†åˆ«ï¼Œæ©ç æ›¿æ¢ï¼ˆMASKï¼‰  
3. **åˆè§„ä¸ä¼¦ç†**ï¼ˆ20minï¼‰ï¼š  
   - æ ¡å›­åœºæ™¯ç‰¹æ®Šè¦æ±‚ï¼ˆç¦æ­¢ä»£è€ƒã€ä½œå¼Šç›¸å…³ä¿¡æ¯ï¼‰  
   - å®¡è®¡æ—¥å¿—è®¾è®¡ï¼ˆè°ã€ä½•æ—¶ã€é—®äº†ä»€ä¹ˆï¼‰

**é˜¶æ®µ 2ï¼šå®æ“è½åœ°ï¼ˆ6hï¼‰**

**æ­¥éª¤ 1ï¼šä¸­é—´ä»¶åŸºç±»ï¼ˆ1hï¼‰**

åœ¨ `middleware/base.py` ä¸­å®šä¹‰ä¸­é—´ä»¶æ¶æ„ï¼š

```python
from abc import ABC, abstractmethod
from typing import Dict, Any, Callable, Optional
from dataclasses import dataclass
import time

@dataclass
class RequestContext:
    """è¯·æ±‚ä¸Šä¸‹æ–‡"""
    user_id: str
    thread_id: str
    message: str
    timestamp: float = None
    metadata: Dict[str, Any] = None
    
    def __post_init__(self):
        if self.timestamp is None:
            self.timestamp = time.time()

@dataclass
class MiddlewareResponse:
    """ä¸­é—´ä»¶å¤„ç†ç»“æœ"""
    allowed: bool
    message: str  # å¯èƒ½å·²è¢«ä¿®æ”¹ï¼ˆå¦‚è„±æ•åï¼‰
    reason: Optional[str] = None  # æ‹¦æˆªåŸå› 
    metadata: Dict[str, Any] = None

class BaseMiddleware(ABC):
    """ä¸­é—´ä»¶åŸºç±»"""
    
    def __init__(self, enabled: bool = True):
        self.enabled = enabled
        self.next_middleware: Optional[BaseMiddleware] = None
    
    def set_next(self, middleware: 'BaseMiddleware'):
        self.next_middleware = middleware
        return middleware  # æ”¯æŒé“¾å¼è°ƒç”¨
    
    def process(self, context: RequestContext) -> MiddlewareResponse:
        """å¤„ç†è¯·æ±‚"""
        if not self.enabled:
            if self.next_middleware:
                return self.next_middleware.process(context)
            return MiddlewareResponse(True, context.message)
        
        # æ‰§è¡Œå½“å‰ä¸­é—´ä»¶é€»è¾‘
        result = self.handle(context)
        
        # å¦‚æœè¢«æ‹¦æˆªæˆ–æ²¡æœ‰ä¸‹ä¸€ä¸ªï¼Œç›´æ¥è¿”å›
        if not result.allowed or not self.next_middleware:
            return result
        
        # ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼ˆå¯èƒ½ä¿®æ”¹äº† messageï¼‰
        new_context = RequestContext(
            user_id=context.user_id,
            thread_id=context.thread_id,
            message=result.message,
            metadata={**(context.metadata or {}), **(result.metadata or {})}
        )
        return self.next_middleware.process(new_context)
    
    @abstractmethod
    def handle(self, context: RequestContext) -> MiddlewareResponse:
        """å…·ä½“å¤„ç†é€»è¾‘ï¼Œå­ç±»å®ç°"""
        pass
```

**æ­¥éª¤ 2ï¼šå››å±‚ä¸­é—´ä»¶å®ç°ï¼ˆ2.5hï¼‰**

åœ¨ `middleware/security_layers.py` ä¸­å®ç°ï¼š

```python
import re
import tiktoken
from .base import BaseMiddleware, RequestContext, MiddlewareResponse

class BudgetControlMiddleware(BaseMiddleware):
    """é¢„ç®—æ§åˆ¶ä¸­é—´ä»¶ï¼šé™åˆ¶ Token æ¶ˆè€—"""
    
    def __init__(self, max_input_tokens: int = 2000, max_daily_cost: float = 10.0):
        super().__init__()
        self.max_input_tokens = max_input_tokens
        self.max_daily_cost = max_daily_cost
        self.user_daily_usage: Dict[str, float] = {}  # ç®€åŒ–ç‰ˆï¼Œå®é™…åº”ç”¨ Redis
        
        # åˆå§‹åŒ– tiktoken
        try:
            self.encoding = tiktoken.encoding_for_model("gpt-4")
        except:
            self.encoding = tiktoken.get_encoding("cl100k_base")
    
    def handle(self, context: RequestContext) -> MiddlewareResponse:
        user_id = context.user_id
        message = context.message
        
        # 1. æ£€æŸ¥è¾“å…¥é•¿åº¦
        token_count = len(self.encoding.encode(message))
        if token_count > self.max_input_tokens:
            return MiddlewareResponse(
                allowed=False,
                message=message,
                reason=f"è¾“å…¥è¿‡é•¿ï¼ˆ{token_count} tokensï¼‰ï¼Œè¶…è¿‡é™åˆ¶ {self.max_input_tokens}"
            )
        
        # 2. æ£€æŸ¥æ—¥é¢„ç®—ï¼ˆæ¨¡æ‹Ÿæˆæœ¬è®¡ç®—ï¼š$0.002 / 1K tokensï¼‰
        cost = (token_count / 1000) * 0.002
        current_usage = self.user_daily_usage.get(user_id, 0)
        
        if current_usage + cost > self.max_daily_cost:
            return MiddlewareResponse(
                allowed=False,
                message=message,
                reason=f"è¶…å‡ºæ—¥é¢„ç®—ï¼ˆå½“å‰: ${current_usage:.4f}, é™åˆ¶: ${self.max_daily_cost}ï¼‰"
            )
        
        self.user_daily_usage[user_id] = current_usage + cost
        
        return MiddlewareResponse(
            allowed=True,
            message=message,
            metadata={"input_tokens": token_count, "estimated_cost": cost}
        )

class TruncationMiddleware(BaseMiddleware):
    """æ¶ˆæ¯æˆªæ–­ä¸­é—´ä»¶ï¼šé˜²æ­¢ä¸Šä¸‹æ–‡çª—å£æº¢å‡º"""
    
    def __init__(self, max_messages: int = 10, max_chars_per_msg: int = 1000):
        super().__init__()
        self.max_messages = max_messages
        self.max_chars_per_msg = max_chars_per_msg
    
    def handle(self, context: RequestContext) -> MiddlewareResponse:
        message = context.message
        
        # ç­–ç•¥ï¼šå¦‚æœæ¶ˆæ¯åˆ—è¡¨è¿‡é•¿ï¼Œä¿ç•™ç³»ç»Ÿæç¤ºå’Œæœ€è¿‘ N æ¡
        # ç®€åŒ–å¤„ç†ï¼šç›´æ¥æˆªæ–­å•æ¡æ¶ˆæ¯é•¿åº¦
        if len(message) > self.max_chars_per_msg:
            truncated = message[:self.max_chars_per_msg] + "...[æˆªæ–­]"
            return MiddlewareResponse(
                allowed=True,
                message=truncated,
                metadata={"truncated": True, "original_length": len(message)}
            )
        
        return MiddlewareResponse(allowed=True, message=message)

class SensitiveWordMiddleware(BaseMiddleware):
    """æ•æ„Ÿè¯è¿‡æ»¤ä¸­é—´ä»¶"""
    
    def __init__(self):
        super().__init__()
        # æ ¡å›­åœºæ™¯æ•æ„Ÿè¯åº“ï¼ˆç¤ºä¾‹ï¼‰
        self.sensitive_patterns = [
            r'\bä»£è€ƒ\b', r'\bæ›¿è€ƒ\b', r'\bæªæ‰‹\b',
            r'\båŠè¯\b', r'\bå‡è¯\b',
            r'\bè¾±éª‚æ•™å¸ˆ\b', r'\bæ”»å‡»å­¦æ ¡\b',
            r'\b(ååŠ¨|è‰²æƒ…|æš´åŠ›)\b',  # æ­£åˆ™ç¤ºä¾‹
        ]
        self.compiled_patterns = [re.compile(p, re.IGNORECASE) for p in self.sensitive_patterns]
    
    def handle(self, context: RequestContext) -> MiddlewareResponse:
        message = context.message
        
        for pattern in self.compiled_patterns:
            if pattern.search(message):
                matched = pattern.findall(message)
                return MiddlewareResponse(
                    allowed=False,
                    message=message,
                    reason=f"æ£€æµ‹åˆ°æ•æ„Ÿè¯ï¼š{matched}",
                    metadata={"violation_type": "sensitive_word", "matched": matched}
                )
        
        return MiddlewareResponse(allowed=True, message=message)

class PIIDetectionMiddleware(BaseMiddleware):
    """PII æ£€æµ‹ä¸è„±æ•ä¸­é—´ä»¶"""
    
    def __init__(self, mask_char: str = "*"):
        super().__init__()
        self.mask_char = mask_char
        # PII æ­£åˆ™æ¨¡å¼
        self.pii_patterns = {
            "phone": (re.compile(r'\b1[3-9]\d{9}\b'), "æ‰‹æœºå·"),
            "id_card": (re.compile(r'\b\d{17}[\dXx]|\d{15}\b'), "èº«ä»½è¯å·"),
            "student_id": (re.compile(r'\b20\d{8}\b'), "å­¦å·"),  # å¦‚ 20240001
            "bank_card": (re.compile(r'\b\d{16}|\d{19}\b'), "é“¶è¡Œå¡å·"),
            "email": (re.compile(r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'), "é‚®ç®±")
        }
    
    def handle(self, context: RequestContext) -> MiddlewareResponse:
        message = context.message
        detected_pii = []
        
        for pii_type, (pattern, label) in self.pii_patterns.items():
            matches = pattern.findall(message)
            for match in matches:
                # è„±æ•å¤„ç†
                if pii_type == "phone":
                    masked = match[:3] + self.mask_char * 4 + match[-4:]
                elif pii_type == "id_card":
                    masked = match[:6] + self.mask_char * 8 + match[-4:]
                else:
                    masked = self.mask_char * len(match)
                
                message = message.replace(match, masked)
                detected_pii.append({"type": label, "original": match, "masked": masked})
        
        if detected_pii:
            return MiddlewareResponse(
                allowed=True,  # PII å¯ä»¥è„±æ•åç»§ç»­ï¼Œä¹Ÿå¯ä»¥æ”¹ä¸º False æ‹¦æˆª
                message=message,
                metadata={"pii_detected": True, "pii_items": detected_pii}
            )
        
        return MiddlewareResponse(allowed=True, message=message)
```

**æ­¥éª¤ 3ï¼šä¸­é—´ä»¶é“¾ç»„è£…ï¼ˆ1hï¼‰**

åœ¨ `middleware/chain.py` ä¸­æ„å»ºè´£ä»»é“¾ï¼š

```python
from .base import BaseMiddleware, RequestContext, MiddlewareResponse
from .security_layers import (
    BudgetControlMiddleware,
    TruncationMiddleware,
    SensitiveWordMiddleware,
    PIIDetectionMiddleware
)

class SecurityMiddlewareChain:
    """å®‰å…¨ä¸­é—´ä»¶é“¾ç®¡ç†å™¨"""
    
    def __init__(self):
        # æŒ‰é¡ºåºåˆå§‹åŒ–ï¼šé¢„ç®— â†’ æˆªæ–­ â†’ æ•æ„Ÿè¯ â†’ PII
        self.budget = BudgetControlMiddleware(max_input_tokens=2000)
        self.truncation = TruncationMiddleware(max_chars_per_msg=1500)
        self.sensitive = SensitiveWordMiddleware()
        self.pii = PIIDetectionMiddleware()
        
        # ç»„è£…é“¾
        self.budget.set_next(self.truncation).set_next(self.sensitive).set_next(self.pii)
        
        self.entry_point = self.budget
    
    def process(self, user_id: str, thread_id: str, message: str) -> MiddlewareResponse:
        """å¤„ç†ç”¨æˆ·è¾“å…¥"""
        context = RequestContext(
            user_id=user_id,
            thread_id=thread_id,
            message=message
        )
        return self.entry_point.process(context)
    
    def get_audit_log(self, response: MiddlewareResponse) -> dict:
        """ç”Ÿæˆå®¡è®¡æ—¥å¿—"""
        return {
            "allowed": response.allowed,
            "reason": response.reason,
            "metadata": response.metadata,
            "processed_message": response.message if response.allowed else None
        }

# å…¨å±€å®ä¾‹
security_chain = SecurityMiddlewareChain()
```

**æ­¥éª¤ 4ï¼šä¸ Agent é›†æˆï¼ˆ1hï¼‰**

ä¿®æ”¹ Day 4 çš„ StateGraphï¼ŒåŠ å…¥ä¸­é—´ä»¶ï¼š

```python
from middleware.chain import security_chain

def secure_entry_node(state: RegistrationState):
    """å®‰å…¨å…¥å£èŠ‚ç‚¹ï¼šå…ˆè¿‡ä¸­é—´ä»¶ï¼Œå†å¤„ç†ä¸šåŠ¡"""
    last_message = state["messages"][-1].content if state["messages"] else ""
    user_id = "student_001"  # å®é™…ä» state æˆ– config è·å–
    
    # æ‰§è¡Œå®‰å…¨é“¾
    result = security_chain.process(
        user_id=user_id,
        thread_id="thread_001",
        message=last_message
    )
    
    if not result.allowed:
        # æ‹¦æˆªï¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œä¸è¿›å…¥ä¸šåŠ¡é€»è¾‘
        return {
            "messages": [AIMessage(content=f"âš ï¸ å®‰å…¨æ‹¦æˆªï¼š{result.reason}")],
            "current_step": "error"
        }
    
    # è„±æ•åçš„æ¶ˆæ¯æ›¿æ¢åŸæ¶ˆæ¯ï¼ˆä¿æŠ¤ä¸‹æ¸¸ï¼‰
    if result.metadata.get("pii_detected"):
        # æ›´æ–° state ä¸­çš„æ¶ˆæ¯ä¸ºè„±æ•ç‰ˆæœ¬
        sanitized_msg = result.message
        return {
            "messages": [HumanMessage(content=sanitized_msg)],
            "metadata": {"security_check": "passed", "pii_masked": True}
        }
    
    return {"metadata": {"security_check": "passed"}}
```

**æ­¥éª¤ 5ï¼šæµ‹è¯•ä¸æ”»é˜²ï¼ˆ0.5hï¼‰**

åœ¨ `tests/test_security.py` ä¸­ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼š

```python
def test_security_layers():
    chain = SecurityMiddlewareChain()
    
    test_cases = [
        ("æ­£å¸¸é—®é¢˜ï¼šå›¾ä¹¦é¦†å‡ ç‚¹å¼€é—¨ï¼Ÿ", True, None),
        ("æˆ‘è¦æ‰¾æªæ‰‹ä»£è€ƒé«˜æ•°", False, "æ•æ„Ÿè¯"),
        ("æˆ‘çš„èº«ä»½è¯å·æ˜¯110101200001011234", True, "PII"),  # åº”è„±æ•
        ("x" * 3000, False, "è¿‡é•¿"),  # æˆªæ–­æˆ–æ‹¦æˆª
    ]
    
    for msg, expected_allowed, expected_type in test_cases:
        result = chain.process("user_1", "thread_1", msg)
        status = "âœ…" if result.allowed == expected_allowed else "âŒ"
        print(f"{status} ç±»å‹:{expected_type} å…è®¸:{result.allowed} åŸå› :{result.reason}")
```

**æ­¥éª¤ 6ï¼šæäº¤ï¼ˆ0.5hï¼‰**

```bash
git add .
git commit -m "feat(day5): å®ç°å››å±‚å®‰å…¨ä¸­é—´ä»¶ä½“ç³»
- é¢„ç®—æ§åˆ¶ï¼ˆTokené™åˆ¶+æˆæœ¬ä¼°ç®—ï¼‰
- æ¶ˆæ¯æˆªæ–­ï¼ˆé˜²æ­¢ä¸Šä¸‹æ–‡æº¢å‡ºï¼‰
- æ•æ„Ÿè¯è¿‡æ»¤ï¼ˆTrieæ ‘+æ­£åˆ™ï¼‰
- PIIæ£€æµ‹è„±æ•ï¼ˆèº«ä»½è¯/æ‰‹æœºå·/å­¦å·æ©ç ï¼‰
- è´£ä»»é“¾æ¨¡å¼è®¾è®¡ï¼Œæ”¯æŒåŠ¨æ€å¼€å…³"
git push origin feature/day5-security-middleware
```

#### å…­ã€è€ƒæ ¸æ–¹æ³•ï¼ˆé‡åŒ–è¯„åˆ†ï¼Œ10 åˆ†ï¼‰

| è€ƒæ ¸é¡¹ | åˆ†å€¼ | è¯„åˆ†æ ‡å‡† |
|-------|------|---------|
| **ä¸­é—´ä»¶æ¶æ„** | 2 åˆ† | ä½¿ç”¨è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of Responsibilityï¼‰ï¼ŒåŸºç±»è®¾è®¡åˆç†ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ |
| **é¢„ç®—æ§åˆ¶** | 2 åˆ† | å®ç° Token è®¡æ•°ï¼ˆtiktokenï¼‰ï¼Œè®¾ç½®è¾“å…¥ä¸Šé™å’Œæ—¥é¢„ç®—ï¼Œè¶…å‡ºæ—¶æ‹¦æˆª |
| **æ•æ„Ÿè¯è¿‡æ»¤** | 2 åˆ† | æ­£åˆ™åŒ¹é…æ•æ„Ÿè¯ï¼ˆä»£è€ƒã€å‡è¯ç­‰ï¼‰ï¼Œå‘½ä¸­æ—¶æ‹’ç»å¹¶è¿”å›åŸå›  |
| **PII è„±æ•** | 2 åˆ† | è¯†åˆ«èº«ä»½è¯ã€æ‰‹æœºå·ã€å­¦å·ç­‰ï¼Œä½¿ç”¨æ©ç ï¼ˆ***ï¼‰æ›¿æ¢ï¼Œä¿ç•™åŸå§‹é•¿åº¦æç¤º |
| **é›†æˆæµ‹è¯•** | 1 åˆ† | æä¾›æµ‹è¯•ç”¨ä¾‹è¦†ç›–æ­£å¸¸/æ•æ„Ÿ/PII/è¶…é•¿åœºæ™¯ï¼Œé€šè¿‡æ‰€æœ‰æµ‹è¯• |
| **å®¡è®¡æ—¥å¿—** | 1 åˆ† | è®°å½•æ‹¦æˆªåŸå› ã€è„±æ•å­—æ®µã€æ—¶é—´æˆ³ï¼Œæ”¯æŒåˆè§„å®¡æŸ¥ |

---

## Day 6ï¼šäººæœºäº¤äº’ä¸ HITL

#### ä¸€ã€å‰æœŸçŸ¥è¯†ï¼ˆè¯¾å‰é¢„ä¹ ï¼Œ1hï¼‰

**å‚è€ƒèµ„æ–™**ï¼š
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/äººæœºå›ç¯.md` - Human-in-the-loop æ¦‚å¿µ
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/LangGraphä¸­æ–­æœºåˆ¶.md` - Interrupt ä¸ Resume

1. **HITL åœºæ™¯**ï¼šä½•æ—¶éœ€è¦äººå·¥ä»‹å…¥ï¼Ÿï¼ˆé«˜é£é™©æ“ä½œã€ä¿¡æ¯ç¡®è®¤ã€å¼‚å¸¸å¤„ç†ï¼‰ï¼›
2. **ä¸­æ–­ä¸æ¢å¤**ï¼šLangGraph çš„ `interrupt` å‡½æ•°ï¼Œ`Command(resume=...)` æœºåˆ¶ï¼›
3. **å®¡æ ¸å·¥ä½œå°**ï¼šäººå·¥å®¡æ ¸ç•Œé¢è®¾è®¡ï¼ˆæ‰¹å‡†/æ‹’ç»/ä¿®æ”¹ï¼‰ã€‚

#### äºŒã€å®éªŒç›®æ ‡

1. å®ç° HITLï¼ˆHuman-in-the-loopï¼‰ä¸­æ–­æœºåˆ¶ï¼Œåœ¨å…³é”®èŠ‚ç‚¹æš‚åœç­‰å¾…äººå·¥ç¡®è®¤ï¼›
2. æ„å»ºäººå·¥å®¡æ ¸æµç¨‹ï¼ˆå¦‚ï¼šç¼´è´¹é‡‘é¢ç¡®è®¤ã€æ•æ„Ÿæ“ä½œæˆæƒï¼‰ï¼›
3. è®¾è®¡ä¸­æ–­æ¢å¤çš„æ•°æ®ä¸€è‡´æ€§ä¿è¯ã€‚

#### ä¸‰ã€éš¾ç‚¹é‡ç‚¹

- **é‡ç‚¹**ï¼š`interrupt()` çš„æ­£ç¡®ä½¿ç”¨ï¼Œ`Command` æ¢å¤æ‰§è¡Œï¼›
- **éš¾ç‚¹**ï¼šä¸­æ–­æœŸé—´çš„çŠ¶æ€ä¿æŒï¼Œå¹¶å‘æƒ…å†µä¸‹çš„çº¿ç¨‹å®‰å…¨ï¼ˆå¤šäººåŒæ—¶å®¡æ ¸ï¼‰ã€‚

#### å››ã€çŸ¥è¯†åŸºç¡€

- **å¿…å¤‡**ï¼šPython å¼‚æ­¥ç¼–ç¨‹åŸºç¡€ï¼Œ`async/await`ï¼›
- **å¯é€‰**ï¼šäº†è§£ä¸­æ–­å¤„ç†æœºåˆ¶ï¼ˆå¦‚æ“ä½œç³»ç»Ÿä¸­æ–­ï¼‰ã€‚

#### äº”ã€å®éªŒæ­¥éª¤ï¼ˆ8hï¼Œå« 2h ç†è®ºè®²è§£ï¼‰

**é˜¶æ®µ 1ï¼šç†è®ºè®²è§£ï¼ˆ2hï¼‰**

1. **HITL è®¾è®¡æ¨¡å¼**ï¼ˆ30minï¼‰ï¼š  
   - å®¡æ‰¹æ¨¡å¼ï¼ˆApprovalï¼‰ï¼šAI å»ºè®® â†’ äººå·¥æ‰¹å‡† â†’ æ‰§è¡Œ  
   - ç¼–è¾‘æ¨¡å¼ï¼ˆEditï¼‰ï¼šAI è‰ç¨¿ â†’ äººå·¥ä¿®æ”¹ â†’ æäº¤  
   - æ¥ç®¡æ¨¡å¼ï¼ˆTakeoverï¼‰ï¼šAI å¼‚å¸¸ â†’ äººå·¥æ¥ç®¡ â†’ æ¢å¤  
2. **LangGraph Interrupt æ·±åº¦è§£æ**ï¼ˆ40minï¼‰ï¼š  
   - `interrupt(payload)`ï¼šæŠ›å‡ºç‰¹æ®Šå¼‚å¸¸ï¼Œä¿å­˜æ£€æŸ¥ç‚¹  
   - `Command(resume=value)`ï¼šä»æ£€æŸ¥ç‚¹æ¢å¤ï¼Œä¼ å…¥äººå·¥è¾“å…¥  
   - å¤šä¸­æ–­ç‚¹ç®¡ç†ï¼ˆä¸­æ–­æ ˆï¼‰  
3. **å®¡æ ¸å·¥ä½œå°è®¾è®¡**ï¼ˆ30minï¼‰ï¼š  
   - å¾…åŠé˜Ÿåˆ—ï¼ˆPending Queueï¼‰  
   - å†²çªè§£å†³ï¼ˆå¤šäººåŒæ—¶å¤„ç†ï¼‰  
   - å®¡è®¡è¿½è¸ªï¼ˆè°ã€ä½•æ—¶ã€åšäº†ä»€ä¹ˆå†³å®šï¼‰

**é˜¶æ®µ 2ï¼šå®æ“è½åœ°ï¼ˆ6hï¼‰**

**æ­¥éª¤ 1ï¼šä¸­æ–­èŠ‚ç‚¹è®¾è®¡ï¼ˆ1.5hï¼‰**

åœ¨ `agents/day6_hitl_agent.py` ä¸­å®ç°ï¼š

```python
from typing import TypedDict, Optional
from langgraph.graph import StateGraph
from langgraph.types import interrupt, Command
from langgraph.checkpoint.memory import MemorySaver
from langchain_core.messages import HumanMessage, AIMessage

class HITLState(TypedDict):
    messages: list
    pending_action: Optional[str]  # å¾…ç¡®è®¤çš„æ“ä½œ
    pending_data: Optional[dict]   # æ“ä½œç›¸å…³æ•°æ®
    human_decision: Optional[str]  # 'approved', 'rejected', 'modified'
    final_result: Optional[str]

def process_payment_request(state: HITLState):
    """å¤„ç†ç¼´è´¹è¯·æ±‚ï¼šéœ€è¦äººå·¥ç¡®è®¤é‡‘é¢"""
    # æ¨¡æ‹Ÿè®¡ç®—åº”ç¼´è´¹ç”¨
    tuition = 5000.00
    accommodation = 1200.00
    total = tuition + accommodation
    
    # å‡†å¤‡å¾…ç¡®è®¤ä¿¡æ¯
    action_payload = {
        "action": "charge_payment",
        "amount": total,
        "items": {
            "å­¦è´¹": tuition,
            "ä½å®¿è´¹": accommodation
        },
        "student_id": "2024001"
    }
    
    # ä¸­æ–­ç­‰å¾…äººå·¥ç¡®è®¤
    # interrupt ä¼šæš‚åœå›¾æ‰§è¡Œï¼Œç­‰å¾…å¤–éƒ¨ä¼ å…¥ Command(resume=...)
    human_response = interrupt(
        {
            "type": "payment_confirmation",
            "message": f"è¯·ç¡®è®¤ä»¥ä¸‹ç¼´è´¹ä¿¡æ¯ï¼š",
            "details": action_payload,
            "options": ["approve", "reject", "modify"]
        }
    )
    
    # æ¢å¤åå¤„ç†äººå·¥è¾“å…¥
    if human_response["decision"] == "approve":
        return {
            "pending_action": "charge_payment",
            "pending_data": action_payload,
            "human_decision": "approved",
            "messages": [AIMessage(content="âœ… ç¼´è´¹ç”³è¯·å·²æ‰¹å‡†ï¼Œæ­£åœ¨å¤„ç†...")]
        }
    elif human_response["decision"] == "reject":
        return {
            "human_decision": "rejected",
            "messages": [AIMessage(content="âŒ ç¼´è´¹ç”³è¯·å·²è¢«æ‹’ç»ï¼Œè¯·è”ç³»è´¢åŠ¡å¤„ã€‚")]
        }
    else:  # modify
        # ä¿®æ”¹é‡‘é¢åé‡æ–°ç¡®è®¤ï¼ˆé€’å½’æˆ–é‡æ–°è¿›å…¥èŠ‚ç‚¹ï¼‰
        new_amount = human_response.get("modified_amount", total)
        return {
            "pending_data": {**action_payload, "amount": new_amount},
            "messages": [AIMessage(content=f"é‡‘é¢å·²ä¿®æ”¹ä¸º {new_amount}ï¼Œè¯·é‡æ–°ç¡®è®¤ã€‚")]
        }

def execute_payment(state: HITLState):
    """æ‰§è¡Œç¼´è´¹ï¼ˆä»…åœ¨è¢«æ‰¹å‡†åï¼‰"""
    if state.get("human_decision") != "approved":
        return {"final_result": "cancelled"}
    
    # æ¨¡æ‹Ÿæ‰§è¡Œ
    data = state["pending_data"]
    return {
        "final_result": f"æˆåŠŸæ‰£æ¬¾ {data['amount']} å…ƒ",
        "messages": [AIMessage(content=f"âœ… ç¼´è´¹æˆåŠŸï¼é‡‘é¢ï¼š{data['amount']} å…ƒ")]
    }

def create_hitl_workflow():
    """åˆ›å»ºå¸¦ HITL çš„å·¥ä½œæµ"""
    workflow = StateGraph(HITLState)
    
    workflow.add_node("request_payment", process_payment_request)
    workflow.add_node("execute", execute_payment)
    
    workflow.set_entry_point("request_payment")
    workflow.add_edge("request_payment", "execute")
    workflow.add_edge("execute", "__end__")
    
    # ä½¿ç”¨æ£€æŸ¥ç‚¹ä¿å­˜ä¸­æ–­çŠ¶æ€
    checkpointer = MemorySaver()
    app = workflow.compile(checkpointer=checkpointer)
    
    return app
```

**æ­¥éª¤ 2ï¼šå®¡æ ¸å·¥ä½œå°æ¨¡æ‹Ÿï¼ˆ1.5hï¼‰**

åˆ›å»º `ui/audit_console.py` æ¨¡æ‹Ÿäººå·¥å®¡æ ¸å°ï¼š

```python
import time
from typing import Dict, Any

class AuditConsole:
    """æ¨¡æ‹Ÿäººå·¥å®¡æ ¸å·¥ä½œå°ï¼ˆå®é™…åº”ä¸º Web ç•Œé¢ï¼‰"""
    
    def __init__(self):
        self.pending_tasks: Dict[str, Any] = {}  # thread_id -> task
    
    def register_task(self, thread_id: str, interrupt_payload: dict):
        """æ³¨å†Œå¾…å®¡æ ¸ä»»åŠ¡"""
        self.pending_tasks[thread_id] = {
            "payload": interrupt_payload,
            "status": "pending",
            "created_at": time.time()
        }
        print(f"\nğŸ”” æ–°å®¡æ ¸ä»»åŠ¡ï¼ˆThread: {thread_id}ï¼‰")
        print(f"ç±»å‹ï¼š{interrupt_payload['type']}")
        print(f"è¯¦æƒ…ï¼š{interrupt_payload['details']}")
        print("é€‰é¡¹ï¼šapprove | reject | modify")
    
    def make_decision(self, thread_id: str, decision: str, **kwargs):
        """äººå·¥åšå‡ºå†³å®š"""
        if thread_id not in self.pending_tasks:
            print(f"âŒ ä»»åŠ¡ {thread_id} ä¸å­˜åœ¨")
            return None
        
        task = self.pending_tasks[thread_id]
        task["status"] = "processed"
        task["decision"] = decision
        
        # æ„å»º resume æ•°æ®
        resume_data = {
            "decision": decision,
            **kwargs
        }
        
        print(f"âœ… å·²å¤„ç†ä»»åŠ¡ {thread_id}ï¼š{decision}")
        return resume_data

# å…¨å±€å®¡æ ¸å°
audit_console = AuditConsole()
```

**æ­¥éª¤ 3ï¼šHITL è¿è¡Œå™¨ï¼ˆ1.5hï¼‰**

å®ç°æ”¯æŒä¸­æ–­çš„è¿è¡Œé€»è¾‘ï¼š

```python
def run_with_hitl():
    """è¿è¡Œæ”¯æŒ HITL çš„ Agent"""
    app = create_hitl_workflow()
    thread_id = "audit_demo_001"
    config = {"configurable": {"thread_id": thread_id}}
    
    # å¯åŠ¨å·¥ä½œæµï¼ˆä¼šä¸­æ–­åœ¨ payment èŠ‚ç‚¹ï¼‰
    print("ğŸš€ å¯åŠ¨æŠ¥åˆ°ç¼´è´¹æµç¨‹...")
    
    # ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œä¼šæ‰§è¡Œåˆ° interrupt å¤„æš‚åœ
    for event in app.stream(
        {"messages": [HumanMessage(content="æˆ‘è¦äº¤å­¦è´¹")]},
        config,
        stream_mode="values"
    ):
        print(f"çŠ¶æ€ï¼š{event}")
        
        # æ£€æŸ¥æ˜¯å¦ä¸­æ–­
        if "__interrupt__" in event:
            interrupt_info = event["__interrupt__"][0]
            # æ³¨å†Œåˆ°å®¡æ ¸å°
            audit_console.register_task(thread_id, interrupt_info.value)
            
            # æ¨¡æ‹Ÿäººå·¥å®¡æ ¸ï¼ˆå®é™…åº”å¼‚æ­¥ç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼‰
            print("\nâ³ ç­‰å¾…äººå·¥å®¡æ ¸...")
            time.sleep(2)  # æ¨¡æ‹Ÿç­‰å¾…
            
            # æ¨¡æ‹Ÿäººå·¥å†³å®šï¼ˆapprove/reject/modifyï¼‰
            decision = input("è¯·è¾“å…¥å†³å®šï¼ˆapprove/reject/modifyï¼‰ï¼š").strip()
            
            resume_data = {"decision": decision}
            if decision == "modify":
                new_amount = input("è¯·è¾“å…¥ä¿®æ”¹åçš„é‡‘é¢ï¼š")
                resume_data["modified_amount"] = float(new_amount)
            
            # æ¢å¤æ‰§è¡Œ
            print("ğŸ”„ æ¢å¤æ‰§è¡Œ...")
            for resume_event in app.stream(
                Command(resume=resume_data),
                config,
                stream_mode="values"
            ):
                if "messages" in resume_event:
                    print(f"ğŸ¤–ï¼š{resume_event['messages'][-1].content}")
                if "final_result" in resume_event:
                    print(f"ğŸ“Š æœ€ç»ˆç»“æœï¼š{resume_event['final_result']}")

if __name__ == "__main__":
    run_with_hitl()
```

**æ­¥éª¤ 4ï¼šå¤šä¸­æ–­ç‚¹ç®¡ç†ï¼ˆ1hï¼‰**

æ‰©å±•æ”¯æŒå¤šä¸ªä¸­æ–­ç‚¹ï¼ˆå¦‚ï¼šææ–™å®¡æ ¸ â†’ ç¼´è´¹ç¡®è®¤ â†’ å®¿èˆé€‰æ‹©ï¼‰ï¼š

```python
def material_review_node(state: HITLState):
    """ææ–™å®¡æ ¸ä¸­æ–­ç‚¹"""
    return interrupt({
        "type": "document_review",
        "documents": ["èº«ä»½è¯.pdf", "å½•å–é€šçŸ¥ä¹¦.pdf"],
        "action": "éªŒè¯ææ–™çœŸå®æ€§"
    })

def dormitory_selection_node(state: HITLState):
    """å®¿èˆé€‰æ‹©ä¸­æ–­ç‚¹ï¼ˆäººå·¥åˆ†é…æˆ–ç¡®è®¤ï¼‰"""
    return interrupt({
        "type": "dormitory_assignment",
        "options": ["A1-301", "A1-302", "A2-205"],
        "action": "ç¡®è®¤å®¿èˆåˆ†é…"
    })

# è·¯ç”±å‡½æ•°æ ¹æ®çŠ¶æ€å†³å®šä¸‹ä¸€ä¸ªä¸­æ–­ç‚¹
def route_to_next_step(state: HITLState):
    if state.get("human_decision") == "rejected":
        return "end"
    if not state.get("material_verified"):
        return "material_review"
    if not state.get("payment_confirmed"):
        return "payment"
    if not state.get("dormitory_confirmed"):
        return "dormitory"
    return "completed"
```

**æ­¥éª¤ 5ï¼šå¼‚å¸¸ä¸è¶…æ—¶å¤„ç†ï¼ˆ0.5hï¼‰**

æ·»åŠ è¶…æ—¶æœºåˆ¶ï¼š

```python
def check_timeout(state: HITLState):
    """æ£€æŸ¥å®¡æ ¸æ˜¯å¦è¶…æ—¶ï¼ˆå¦‚ 24 å°æ—¶æœªå“åº”ï¼‰"""
    created_at = state.get("pending_data", {}).get("timestamp", 0)
    if time.time() - created_at > 86400:  # 24å°æ—¶
        return {
            "messages": [AIMessage(content="â° å®¡æ ¸è¶…æ—¶ï¼Œæµç¨‹å·²è‡ªåŠ¨å–æ¶ˆï¼Œè¯·é‡æ–°ç”³è¯·ã€‚")],
            "final_result": "timeout"
        }
    return None  # æœªè¶…æ—¶
```

**æ­¥éª¤ 6ï¼šæäº¤ï¼ˆ0.5hï¼‰**

```bash
git add .
git commit -m "feat(day6): å®ç° HITL äººæœºå›ç¯æœºåˆ¶
- ä½¿ç”¨ interrupt() åœ¨ç¼´è´¹ç¡®è®¤ç‚¹æš‚åœæµç¨‹
- æ„å»ºæ¨¡æ‹Ÿå®¡æ ¸å·¥ä½œå°ï¼ˆAuditConsoleï¼‰
- å®ç° Command(resume=...) æ¢å¤æ‰§è¡Œ
- æ”¯æŒ approve/reject/modify ä¸‰ç§å†³ç­–
- æ·»åŠ å¤šä¸­æ–­ç‚¹è·¯ç”±ï¼ˆææ–™/ç¼´è´¹/å®¿èˆï¼‰"
git push origin feature/day6-hitl
```

#### å…­ã€è€ƒæ ¸æ–¹æ³•ï¼ˆé‡åŒ–è¯„åˆ†ï¼Œ10 åˆ†ï¼‰

| è€ƒæ ¸é¡¹ | åˆ†å€¼ | è¯„åˆ†æ ‡å‡† |
|-------|------|---------|
| **ä¸­æ–­å®ç°** | 3 åˆ† | æ­£ç¡®ä½¿ç”¨ `interrupt()` æš‚åœçŠ¶æ€æœºï¼Œä½¿ç”¨ `Command(resume=...)` æ¢å¤ï¼Œæ£€æŸ¥ç‚¹ä¿å­˜å®Œæ•´ |
| **å®¡æ ¸å°è®¾è®¡** | 2 åˆ† | å®ç°å¾…åŠä»»åŠ¡æ³¨å†Œã€å†³ç­–è¾“å…¥ã€çŠ¶æ€è·Ÿè¸ªï¼ˆè‡³å°‘æ”¯æŒ approve/rejectï¼‰ |
| **æ•°æ®ä¼ é€’** | 2 åˆ† | ä¸­æ–­æ—¶ä¼ é€’ä¸Šä¸‹æ–‡ï¼ˆå¦‚ç¼´è´¹é‡‘é¢ã€å­¦ç”Ÿä¿¡æ¯ï¼‰ï¼Œæ¢å¤æ—¶æ­£ç¡®æ¥æ”¶äººå·¥å†³ç­– |
| **å¤šä¸­æ–­ç‚¹** | 2 åˆ† | å®ç°è‡³å°‘ 2 ä¸ªä¸åŒçš„ä¸­æ–­ç‚¹ï¼ˆå¦‚ææ–™å®¡æ ¸ + ç¼´è´¹ç¡®è®¤ï¼‰ï¼Œè·¯ç”±æ­£ç¡® |
| **å¼‚å¸¸å¤„ç†** | 1 åˆ† | å¤„ç†éæ³•è¾“å…¥ï¼ˆå¦‚åœ¨ä¸­æ–­ç‚¹è¾“å…¥æ— æ•ˆå†³ç­–ï¼‰ï¼Œæä¾›è¶…æ—¶æˆ–å–æ¶ˆæœºåˆ¶ |

---

## Day 7ï¼šè®°å¿†ç³»ç»Ÿä¸æŒä¹…åŒ–

#### ä¸€ã€å‰æœŸçŸ¥è¯†ï¼ˆè¯¾å‰é¢„ä¹ ï¼Œ1hï¼‰

**å‚è€ƒèµ„æ–™**ï¼š
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/è®°å¿†ç±»å‹.md` - çŸ­æœŸè®°å¿† vs é•¿æœŸè®°å¿†
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/å‘é‡è®°å¿†åº“.md` - Memory Vector Store

1. **è®°å¿†åˆ†å±‚**ï¼šçŸ­æœŸè®°å¿†ï¼ˆå¯¹è¯å†å²ï¼ŒThread çº§ï¼‰ vs é•¿æœŸè®°å¿†ï¼ˆç”¨æˆ·ç”»åƒï¼ŒUser çº§ï¼‰ï¼›
2. **è®°å¿†å­˜å‚¨**ï¼šPostgresã€Redisã€SQLite ç­‰æŒä¹…åŒ–æ–¹æ¡ˆå¯¹æ¯”ï¼›
3. **å­¦ç”Ÿç”»åƒ**ï¼šå¦‚ä½•æ„å»ºå’Œç»´æŠ¤ç”¨æˆ·æ¨¡å‹ï¼ˆä¸“ä¸šã€åå¥½ã€å†å²è¡Œä¸ºï¼‰ã€‚

#### äºŒã€å®éªŒç›®æ ‡

1. å®ç°çŸ­æœŸè®°å¿†ï¼ˆThread çº§ Checkpointerï¼‰ï¼šå¯¹è¯å†å²çš„ä¿å­˜ä¸æ¢å¤ï¼›
2. å®ç°é•¿æœŸè®°å¿†ï¼ˆUser çº§ Storeï¼‰ï¼šè·¨ä¼šè¯çš„å­¦ç”Ÿç”»åƒè‡ªåŠ¨æ„å»ºï¼›
3. è®°å¿†æ£€ç´¢ï¼šåŸºäºå‘é‡ç›¸ä¼¼åº¦çš„å†å²è®°å¿†å¬å›ã€‚

#### ä¸‰ã€éš¾ç‚¹é‡ç‚¹

- **é‡ç‚¹**ï¼š`MemorySaver` vs `PostgresSaver` çš„åŒºåˆ«ï¼Œ`Store` æ¥å£çš„ä½¿ç”¨ï¼›
- **éš¾ç‚¹**ï¼šè®°å¿†çš„æ›´æ–°ç­–ç•¥ï¼ˆå¢é‡æ›´æ–° vs å…¨é‡è¦†ç›–ï¼‰ï¼Œè®°å¿†å†²çªè§£å†³ï¼ˆåŒä¸€ä¿¡æ¯çš„ä¸åŒæè¿°ï¼‰ã€‚

#### å››ã€çŸ¥è¯†åŸºç¡€

- **å¿…å¤‡**ï¼šSQL åŸºç¡€ï¼ŒPython å­—å…¸æ“ä½œï¼›
- **å¯é€‰**ï¼šäº†è§£åµŒå…¥å¼æ•°æ®åº“ï¼ˆSQLiteï¼‰ã€‚

#### äº”ã€å®éªŒæ­¥éª¤ï¼ˆ8hï¼Œå« 2h ç†è®ºè®²è§£ï¼‰

**é˜¶æ®µ 1ï¼šç†è®ºè®²è§£ï¼ˆ2hï¼‰**

1. **è®°å¿†ç±»å‹ä¸æ¶æ„**ï¼ˆ30minï¼‰ï¼š  
   - æ„Ÿè§‰è®°å¿† â†’ çŸ­æœŸè®°å¿†ï¼ˆå·¥ä½œè®°å¿†ï¼‰â†’ é•¿æœŸè®°å¿†ï¼ˆå¤–æ˜¾/å†…éšï¼‰  
   - AI æ¨¡æ‹Ÿï¼šContext Windowï¼ˆæ„Ÿè§‰ï¼‰ã€Thread Checkpointerï¼ˆçŸ­æœŸï¼‰ã€Vector Storeï¼ˆé•¿æœŸï¼‰  
2. **LangGraph è®°å¿†æœºåˆ¶**ï¼ˆ40minï¼‰ï¼š  
   - `checkpointer`ï¼šä¿å­˜å®Œæ•´çŠ¶æ€å›¾ï¼Œæ”¯æŒæ—¶é—´æ—…è¡Œï¼ˆTime Travelï¼‰  
   - `store`ï¼šé”®å€¼å¯¹å­˜å‚¨ï¼Œæ”¯æŒå‘½åç©ºé—´ï¼ˆNamespaceï¼‰éš”ç¦»ç”¨æˆ·  
   - `MemorySaver`ï¼ˆå†…å­˜ï¼‰ vs `PostgresSaver`ï¼ˆç”Ÿäº§çº§ï¼‰  
3. **å­¦ç”Ÿç”»åƒå»ºæ¨¡**ï¼ˆ30minï¼‰ï¼š  
   - äº‹å®æ€§è®°å¿†ï¼ˆå§“åã€ä¸“ä¸šã€å®¿èˆï¼‰  
   - åå¥½è®°å¿†ï¼ˆå–œæ¬¢å›¾ä¹¦é¦†ä¸œé¦†ã€å¸¸ç”¨æ”¯ä»˜å®ç¼´è´¹ï¼‰  
   - ç¨‹åºæ€§è®°å¿†ï¼ˆå¸¸ç”¨æŸ¥è¯¢æ¨¡å¼ï¼‰

**é˜¶æ®µ 2ï¼šå®æ“è½åœ°ï¼ˆ6hï¼‰**

**æ­¥éª¤ 1ï¼šçŸ­æœŸè®°å¿†é…ç½®ï¼ˆ1hï¼‰**

å°† Day 4 çš„ MemorySaver å‡çº§ä¸º PostgresSaverï¼ˆä½¿ç”¨ Supabaseï¼‰ï¼š

```python
from langgraph.checkpoint.postgres import PostgresSaver
from psycopg import Connection
import os

def create_checkpointer():
    """åˆ›å»ºåŸºäº Postgres çš„æ£€æŸ¥ç‚¹"""
    # è¿æ¥ Supabase PostgreSQL
    conn_string = os.getenv("SUPABASE_DB_URL")
    
    # ä½¿ç”¨ PostgresSaverï¼ˆéœ€è¦å®‰è£… langgraph-checkpoint-postgresï¼‰
    checkpointer = PostgresSaver(
        conn=Connection.connect(conn_string)
    )
    
    # å»ºè¡¨ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
    checkpointer.setup()
    
    return checkpointer

# åœ¨ StateGraph ä¸­ä½¿ç”¨
# app = workflow.compile(checkpointer=create_checkpointer())
```

**æ­¥éª¤ 2ï¼šé•¿æœŸè®°å¿†å­˜å‚¨ï¼ˆ1.5hï¼‰**

åœ¨ `db/memory_store.py` ä¸­å®ç°å­¦ç”Ÿç”»åƒå­˜å‚¨ï¼š

```python
from langgraph.store.base import BaseStore
from langgraph.store.memory import InMemoryStore
from typing import Dict, Any, Optional
import json

class StudentProfileStore:
    """å­¦ç”Ÿç”»åƒå­˜å‚¨ï¼ˆé•¿æœŸè®°å¿†ï¼‰"""
    
    def __init__(self):
        # ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨ PostgresStore æˆ– RedisStore
        self.store = InMemoryStore()
    
    def update_profile(self, user_id: str, key: str, value: Any):
        """æ›´æ–°å­¦ç”Ÿç”»åƒå­—æ®µ"""
        namespace = (user_id, "profile")
        
        # è·å–ç°æœ‰èµ„æ–™
        existing = self.store.get(namespace, key)
        if existing:
            data = existing.value
            if isinstance(data, dict) and isinstance(value, dict):
                data.update(value)  # åˆå¹¶å­—å…¸
            else:
                data = value  # è¦†ç›–
        else:
            data = value
        
        # ä¿å­˜
        self.store.put(namespace, key, data)
    
    def get_profile(self, user_id: str) -> Dict[str, Any]:
        """è·å–å®Œæ•´å­¦ç”Ÿç”»åƒ"""
        namespace = (user_id, "profile")
        items = self.store.search(namespace)
        
        profile = {}
        for item in items:
            profile[item.key] = item.value
        
        return profile
    
    def add_memory(self, user_id: str, memory: str, importance: int = 1):
        """
        æ·»åŠ è‡ªç„¶è¯­è¨€è®°å¿†ï¼ˆå¦‚"å­¦ç”Ÿè¯¢é—®è¿‡å¥–å­¦é‡‘æ”¿ç­–"ï¼‰
        å®é™…åº”ä½¿ç”¨å‘é‡å­˜å‚¨ï¼Œè¿™é‡Œç®€åŒ–
        """
        namespace = (user_id, "memories")
        memories = self.store.get(namespace, "facts")
        
        if not memories:
            memories = {"facts": []}
        else:
            memories = memories.value
        
        memories["facts"].append({
            "content": memory,
            "importance": importance,
            "timestamp": time.time()
        })
        
        self.store.put(namespace, "facts", memories)

# å…¨å±€å®ä¾‹
profile_store = StudentProfileStore()
```

**æ­¥éª¤ 3ï¼šè‡ªåŠ¨ç”»åƒæ„å»ºï¼ˆ1.5hï¼‰**

åœ¨ Agent ä¸­è‡ªåŠ¨æå–ä¿¡æ¯æ›´æ–°ç”»åƒï¼š

```python
def extract_profile_info(state: RegistrationState, user_id: str):
    """ä»å¯¹è¯ä¸­è‡ªåŠ¨æå–å­¦ç”Ÿä¿¡æ¯æ›´æ–°ç”»åƒ"""
    messages = state["messages"]
    last_msg = messages[-1].content if messages else ""
    
    # ä½¿ç”¨ LLM æå–ç»“æ„åŒ–ä¿¡æ¯
    extract_prompt = f"""
    ä»ä»¥ä¸‹å¯¹è¯ä¸­æå–å­¦ç”Ÿä¿¡æ¯ï¼Œä»¥ JSON è¿”å›ï¼ˆæ— ä¿¡æ¯åˆ™ç•™ç©ºï¼‰ï¼š
    å¯æå–å­—æ®µï¼šmajorï¼ˆä¸“ä¸šï¼‰, dormitoryï¼ˆå®¿èˆï¼‰, preferenceï¼ˆåå¥½ï¼‰, concernï¼ˆå…³æ³¨ç‚¹ï¼‰
    
    å¯¹è¯ï¼š{last_msg}
    
    ç¤ºä¾‹è¾“å‡ºï¼š
    {{"major": "è®¡ç®—æœºç§‘å­¦", "concern": "å¥–å­¦é‡‘æ”¿ç­–"}}
    """
    
    response = model.invoke(extract_prompt)
    try:
        info = json.loads(response.content)
        
        # æ›´æ–°é•¿æœŸè®°å¿†
        for key, value in info.items():
            if value:
                profile_store.update_profile(user_id, key, value)
                print(f"ğŸ’¾ æ›´æ–°ç”»åƒï¼š{key} = {value}")
    except:
        pass
    
    return state

def get_context_with_memory(state: RegistrationState, user_id: str):
    """è·å–å¢å¼ºä¸Šä¸‹æ–‡ï¼ˆçŸ­æœŸè®°å¿† + é•¿æœŸè®°å¿†ï¼‰"""
    # çŸ­æœŸè®°å¿†å·²åœ¨ state ä¸­
    short_term = state["messages"]
    
    # è·å–é•¿æœŸè®°å¿†
    profile = profile_store.get_profile(user_id)
    
    # æ„å»ºç³»ç»Ÿæç¤º
    memory_prompt = "å·²çŸ¥å­¦ç”Ÿä¿¡æ¯ï¼š\n"
    for key, value in profile.items():
        memory_prompt += f"- {key}: {value}\n"
    
    # æ’å…¥åˆ°æ¶ˆæ¯åˆ—è¡¨å¼€å¤´
    from langchain_core.messages import SystemMessage
    enhanced_messages = [SystemMessage(content=memory_prompt)] + short_term
    
    return {**state, "messages": enhanced_messages}
```

**æ­¥éª¤ 4ï¼šè·¨ä¼šè¯è¯†åˆ«ï¼ˆ1hï¼‰**

å®ç°å­¦ç”Ÿèº«ä»½è¯†åˆ«ä¸è®°å¿†åŠ è½½ï¼š

```python
class MemoryEnhancedAgent:
    """å¸¦è®°å¿†çš„ Agent"""
    
    def __init__(self):
        self.workflow = create_registration_workflow()
        # ä½¿ç”¨ Postgres æ£€æŸ¥ç‚¹
        self.checkpointer = create_checkpointer()
        self.app = self.workflow.compile(checkpointer=self.checkpointer)
    
    def chat(self, user_id: str, message: str, thread_id: Optional[str] = None):
        """
        æ”¯æŒè·¨ä¼šè¯è®°å¿†
        - å¦‚æœ thread_id å­˜åœ¨ï¼Œæ¢å¤å¯¹è¯
        - è‡ªåŠ¨åŠ è½½ç”¨æˆ·ç”»åƒ
        """
        if thread_id is None:
            thread_id = f"{user_id}_{int(time.time())}"
        
        config = {"configurable": {"thread_id": thread_id, "user_id": user_id}}
        
        # åŠ è½½é•¿æœŸè®°å¿†å¹¶æ³¨å…¥
        profile = profile_store.get_profile(user_id)
        system_msg = f"ä½ æ˜¯æ ¡å›­åŠ©æ‰‹ã€‚å­¦ç”Ÿèµ„æ–™ï¼š{json.dumps(profile, ensure_ascii=False)}"
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯æ–°ä¼šè¯
        current_state = self.app.get_state(config)
        if not current_state.values:  # æ–°ä¼šè¯
            initial_state = {
                "messages": [
                    SystemMessage(content=system_msg),
                    HumanMessage(content=message)
                ]
            }
        else:
            initial_state = {"messages": [HumanMessage(content=message)]}
        
        # è¿è¡Œ
        events = []
        for event in self.app.stream(initial_state, config, stream_mode="values"):
            events.append(event)
        
        # è‡ªåŠ¨æ›´æ–°ç”»åƒ
        extract_profile_info(events[-1], user_id)
        
        return events[-1]
```

**æ­¥éª¤ 5ï¼šè®°å¿†å¯è§†åŒ–ï¼ˆ0.5hï¼‰**

æ·»åŠ ç”»åƒæŸ¥çœ‹åŠŸèƒ½ï¼š

```python
def visualize_memory(user_id: str):
    """å¯è§†åŒ–å­¦ç”Ÿè®°å¿†"""
    profile = profile_store.get_profile(user_id)
    
    print(f"ğŸ‘¤ å­¦ç”Ÿ {user_id} çš„æ•°å­—ç”»åƒï¼š")
    print("=" * 40)
    for key, value in profile.items():
        print(f"  {key}: {value}")
    
    # æ£€æŸ¥ç‚¹å†å²ï¼ˆçŸ­æœŸè®°å¿†ï¼‰
    # ä½¿ç”¨ self.checkpointer.list(config) æŸ¥çœ‹å†å²
```

**æ­¥éª¤ 6ï¼šæäº¤ï¼ˆ0.5hï¼‰**

```bash
git add .
git commit -m "feat(day7): å®ç°åˆ†å±‚è®°å¿†ç³»ç»Ÿ
- çŸ­æœŸè®°å¿†ï¼šPostgresSaver æŒä¹…åŒ–å¯¹è¯å†å²
- é•¿æœŸè®°å¿†ï¼šStore æ¥å£ä¿å­˜å­¦ç”Ÿç”»åƒï¼ˆä¸“ä¸š/å®¿èˆ/åå¥½ï¼‰
- è‡ªåŠ¨ç”»åƒæ„å»ºï¼šä»å¯¹è¯ä¸­æå–ä¿¡æ¯æ›´æ–°é•¿æœŸè®°å¿†
- è·¨ä¼šè¯èº«ä»½è¯†åˆ«ä¸è®°å¿†åŠ è½½
- è®°å¿†å¢å¼ºçš„ä¸Šä¸‹æ–‡ç»„è£…"
git push origin feature/day7-memory-system
```

#### å…­ã€è€ƒæ ¸æ–¹æ³•ï¼ˆé‡åŒ–è¯„åˆ†ï¼Œ10 åˆ†ï¼‰

| è€ƒæ ¸é¡¹ | åˆ†å€¼ | è¯„åˆ†æ ‡å‡† |
|-------|------|---------|
| **çŸ­æœŸè®°å¿†** | 2 åˆ† | ä½¿ç”¨ Checkpointerï¼ˆMemorySaver æˆ– PostgresSaverï¼‰ï¼Œèƒ½æ¢å¤å¯¹è¯å†å²ï¼Œæ”¯æŒ thread_id åˆ‡æ¢ |
| **é•¿æœŸè®°å¿†å­˜å‚¨** | 2 åˆ† | ä½¿ç”¨ Store æ¥å£ï¼ˆæˆ–è‡ªå®šä¹‰å®ç°ï¼‰ï¼ŒæŒ‰ user_id å‘½åç©ºé—´éš”ç¦»ï¼Œå­˜å‚¨é”®å€¼å¯¹æ•°æ® |
| **è‡ªåŠ¨æå–** | 2 åˆ† | å®ç°ä»å¯¹è¯ä¸­è‡ªåŠ¨æå–å­¦ç”Ÿä¿¡æ¯ï¼ˆä¸“ä¸šã€å®¿èˆç­‰ï¼‰å¹¶æ›´æ–°ç”»åƒï¼Œä½¿ç”¨ LLM æˆ–è§„åˆ™ |
| **è·¨ä¼šè¯ä¿æŒ** | 2 åˆ† | æ–°ä¼šè¯è‡ªåŠ¨åŠ è½½å†å²ç”»åƒï¼Œå®ç°"è®¤å‡º"è€å­¦ç”Ÿçš„æ•ˆæœ |
| **è®°å¿†åº”ç”¨** | 1 åˆ† | åœ¨å›ç­”ä¸­åˆ©ç”¨è®°å¿†ï¼ˆå¦‚"æ‚¨ä¹‹å‰è¯¢é—®è¿‡å¥–å­¦é‡‘ï¼Œè¿™æ˜¯æœ€æ–°æ”¿ç­–"ï¼‰ |
| **æŒä¹…åŒ–** | 1 åˆ† | æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼ˆSQLite/Postgresï¼‰ï¼Œé‡å¯åè®°å¿†ä¸ä¸¢å¤± |

---

## Day 8ï¼šä¸Šä¸‹æ–‡å·¥ç¨‹ä¸å¤šç§Ÿæˆ·

#### ä¸€ã€å‰æœŸçŸ¥è¯†ï¼ˆè¯¾å‰é¢„ä¹ ï¼Œ1hï¼‰

**å‚è€ƒèµ„æ–™**ï¼š
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/è½¯ä»¶å¤šç§Ÿæˆ·æ¶æ„.md` - ç§Ÿæˆ·éš”ç¦»ç­–ç•¥
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/ä¾èµ–æ³¨å…¥.md` - æ§åˆ¶åè½¬ä¸é…ç½®ç®¡ç†

1. **å¤šç§Ÿæˆ·æ¶æ„**ï¼šSaaS æ¨¡å¼ä¸‹çš„æ•°æ®éš”ç¦»ï¼ˆç‹¬ç«‹æ•°æ®åº“ vs å…±äº« Schemaï¼‰ï¼›
2. **RunnableConfig**ï¼šLangChain/LangGraph çš„é…ç½®ä¼ é€’æœºåˆ¶ï¼›
3. **åŠ¨æ€é…ç½®**ï¼šè¿è¡Œæ—¶åˆ‡æ¢æ¨¡å‹ã€æ¸©åº¦å‚æ•°ã€ç³»ç»Ÿæç¤ºã€‚

#### äºŒã€å®éªŒç›®æ ‡

1. è®¾è®¡ State/Store/Runtime ä¸‰å±‚ä¸Šä¸‹æ–‡ä½“ç³»ï¼›
2. å®ç°å¤šç§Ÿæˆ·éš”ç¦»ï¼ˆä¸åŒå­¦é™¢ä½¿ç”¨ä¸åŒçŸ¥è¯†åº“ã€ä¸åŒæ¨¡å‹ï¼‰ï¼›
3. åŠ¨æ€é…ç½®æ³¨å…¥ï¼šé€šè¿‡ Config æ§åˆ¶ Agent è¡Œä¸ºï¼ˆå¦‚åˆ‡æ¢ä¸¥è‚ƒ/æ´»æ³¼è¯­æ°”ï¼‰ã€‚

#### ä¸‰ã€éš¾ç‚¹é‡ç‚¹

- **é‡ç‚¹**ï¼š`RunnableConfig` çš„ `configurable` å­—æ®µä½¿ç”¨ï¼Œé…ç½®ä¼ æ’­ï¼›
- **éš¾ç‚¹**ï¼šç§Ÿæˆ·éš”ç¦»çš„å®‰å…¨æ€§ï¼ˆé˜²æ­¢è¶Šæƒè®¿é—®å…¶ä»–ç§Ÿæˆ·æ•°æ®ï¼‰ã€‚

#### å››ã€çŸ¥è¯†åŸºç¡€

- **å¿…å¤‡**ï¼šPython ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆContext Managerï¼‰ï¼›
- **å¯é€‰**ï¼šäº†è§£å¾®æœåŠ¡æ¶æ„ä¸­çš„é…ç½®ä¸­å¿ƒï¼ˆå¦‚ Consulã€Nacosï¼‰ã€‚

#### äº”ã€å®éªŒæ­¥éª¤ï¼ˆ8hï¼Œå« 2h ç†è®ºè®²è§£ï¼‰

**é˜¶æ®µ 1ï¼šç†è®ºè®²è§£ï¼ˆ2hï¼‰**

1. **ä¸Šä¸‹æ–‡åˆ†å±‚æ¨¡å‹**ï¼ˆ30minï¼‰ï¼š  
   - **State**ï¼šè¿è¡Œæ—¶çŠ¶æ€ï¼ˆæ˜“å˜ï¼Œè¯·æ±‚çº§ï¼‰  
   - **Store**ï¼šæŒä¹…åŒ–è®°å¿†ï¼ˆåŠæŒä¹…ï¼Œä¼šè¯çº§ï¼‰  
   - **Runtime**ï¼šé…ç½®ä¸ä¾èµ–ï¼ˆæŒä¹…ï¼Œåº”ç”¨çº§ï¼‰  
2. **RunnableConfig æ·±åº¦è§£æ**ï¼ˆ40minï¼‰ï¼š  
   - `metadata`ï¼šé“¾è·¯è¿½è¸ªä¿¡æ¯  
   - `configurable`ï¼šç”¨æˆ·è‡ªå®šä¹‰é…ç½®ï¼ˆæ¨¡å‹é€‰æ‹©ã€ç§Ÿæˆ· IDï¼‰  
   - `recursion_limit`ï¼šé˜²å¾ªç¯ä¿æŠ¤  
   - é…ç½®åœ¨èŠ‚ç‚¹é—´çš„ä¼ é€’æœºåˆ¶  
3. **å¤šç§Ÿæˆ·å®‰å…¨**ï¼ˆ30minï¼‰ï¼š  
   - è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰åœ¨ Supabase ä¸­çš„å®ç°  
   - å‘½åç©ºé—´éš”ç¦»ï¼ˆNamespace per Tenantï¼‰  
   - é…ç½®æ ¡éªŒï¼ˆé˜²æ­¢ä¼ªé€  tenant_idï¼‰

**é˜¶æ®µ 2ï¼šå®æ“è½åœ°ï¼ˆ6hï¼‰**

**æ­¥éª¤ 1ï¼šé…ç½®æ¨¡å‹å®šä¹‰ï¼ˆ1hï¼‰**

åœ¨ `config/runtime_config.py` ä¸­å®šä¹‰ï¼š

```python
from typing import TypedDict, Optional, Literal
from dataclasses import dataclass

class AgentConfig(TypedDict, total=False):
    """è¿è¡Œæ—¶é…ç½®"""
    # èº«ä»½æ ‡è¯†
    user_id: str
    tenant_id: str  # å­¦é™¢/éƒ¨é—¨ IDï¼Œå¦‚ "cs_dept", "art_dept"
    thread_id: str
    
    # æ¨¡å‹é…ç½®
    model_name: Literal["gpt-4o-mini", "gpt-4o", "qwen-turbo"]
    temperature: float
    
    # ä¸šåŠ¡é…ç½®
    personality: Literal["professional", "friendly", "humorous"]  # äººæ ¼è®¾å®š
    knowledge_scope: list[str]  # å¯è®¿é—®çš„çŸ¥è¯†åº“åˆ—è¡¨
    enable_rag: bool
    enable_kg: bool
    
    # å®‰å…¨ç­–ç•¥
    max_tokens: int
    enable_pii_filter: bool

@dataclass
class TenantConfig:
    """ç§Ÿæˆ·ï¼ˆå­¦é™¢ï¼‰çº§é…ç½®"""
    tenant_id: str
    name: str
    vector_collection: str  # è¯¥ç§Ÿæˆ·çš„å‘é‡é›†åˆå
    neo4j_database: Optional[str]  # å›¾æ•°æ®åº“éš”ç¦»ï¼ˆNeo4j 4.0+ æ”¯æŒå¤šåº“ï¼‰
    system_prompt: str
    allowed_tools: list[str]
    
    # è¡Œçº§å®‰å…¨ç­–ç•¥ï¼ˆRLSï¼‰
    rls_enabled: bool = True
```

**æ­¥éª¤ 2ï¼šé…ç½®åŠ è½½ä¸éªŒè¯ï¼ˆ1hï¼‰**

```python
import os
from functools import lru_cache

class ConfigManager:
    """é…ç½®ç®¡ç†å™¨"""
    
    TENANT_DB = {
        "cs_dept": TenantConfig(
            tenant_id="cs_dept",
            name="è®¡ç®—æœºå­¦é™¢",
            vector_collection="cs_knowledge",
            system_prompt="ä½ æ˜¯è®¡ç®—æœºå­¦é™¢åŠ©æ‰‹ï¼Œæ“…é•¿ç¼–ç¨‹ã€ç®—æ³•ã€ç³»ç»Ÿæ¶æ„ã€‚å›ç­”ç®€æ´ä¸“ä¸šã€‚",
            allowed_tools=["query_handbook", "query_campus_kg", "code_assistant"]
        ),
        "art_dept": TenantConfig(
            tenant_id="art_dept",
            name="è‰ºæœ¯å­¦é™¢",
            vector_collection="art_knowledge",
            system_prompt="ä½ æ˜¯è‰ºæœ¯å­¦é™¢åŠ©æ‰‹ï¼Œå¯Œæœ‰åˆ›æ„å’Œè‰ºæœ¯æ°”è´¨ã€‚å›ç­”å¯Œæœ‰æ„ŸæŸ“åŠ›ã€‚",
            allowed_tools=["query_handbook", "query_campus_kg", "design_inspiration"]
        )
    }
    
    @classmethod
    def get_tenant_config(cls, tenant_id: str) -> TenantConfig:
        """è·å–ç§Ÿæˆ·é…ç½®ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
        if tenant_id not in cls.TENANT_DB:
            raise ValueError(f"æœªçŸ¥ç§Ÿæˆ·ï¼š{tenant_id}")
        return cls.TENANT_DB[tenant_id]
    
    @classmethod
    def validate_access(cls, user_id: str, tenant_id: str) -> bool:
        """éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®è¯¥ç§Ÿæˆ·ï¼ˆç®€åŒ–ç‰ˆï¼‰"""
        # å®é™…åº”æŸ¥è¯¢ç”¨æˆ·-ç§Ÿæˆ·å…³è”è¡¨
        return True  # æ¨¡æ‹ŸéªŒè¯é€šè¿‡
    
    @classmethod
    def build_runnable_config(cls, user_id: str, tenant_id: str, **kwargs) -> dict:
        """æ„å»º RunnableConfig"""
        if not cls.validate_access(user_id, tenant_id):
            raise PermissionError("æ— æƒè®¿é—®è¯¥ç§Ÿæˆ·èµ„æº")
        
        tenant = cls.get_tenant_config(tenant_id)
        
        return {
            "configurable": {
                "user_id": user_id,
                "tenant_id": tenant_id,
                "thread_id": kwargs.get("thread_id", f"{tenant_id}_{user_id}"),
                "vector_collection": tenant.vector_collection,
                "system_prompt": tenant.system_prompt,
                "allowed_tools": tenant.allowed_tools,
                **kwargs
            }
        }
```

**æ­¥éª¤ 3ï¼šèŠ‚ç‚¹çº§åˆ«çš„é…ç½®ä½¿ç”¨ï¼ˆ1.5hï¼‰**

åœ¨ StateGraph èŠ‚ç‚¹ä¸­åŠ¨æ€è¯»å–é…ç½®ï¼š

```python
from langchain_core.runnables import RunnableConfig

def adaptive_response_node(state: RegistrationState, config: RunnableConfig):
    """
    è‡ªé€‚åº”å“åº”èŠ‚ç‚¹ï¼šæ ¹æ®é…ç½®è°ƒæ•´è¡Œä¸º
    config ç”± LangGraph è‡ªåŠ¨æ³¨å…¥
    """
    # ä» config ä¸­æå–è¿è¡Œæ—¶é…ç½®
    configurable = config.get("configurable", {})
    tenant_id = configurable.get("tenant_id", "default")
    personality = configurable.get("personality", "professional")
    system_prompt = configurable.get("system_prompt", "ä½ æ˜¯æ ¡å›­åŠ©æ‰‹ã€‚")
    
    # æ ¹æ®äººæ ¼è°ƒæ•´å›å¤é£æ ¼
    style_instructions = {
        "professional": "ä½¿ç”¨æ­£å¼ã€å‡†ç¡®çš„å­¦æœ¯ç”¨è¯­ã€‚",
        "friendly": "ä½¿ç”¨äº²åˆ‡ã€é¼“åŠ±æ€§çš„è¯­è¨€ï¼Œé€‚å½“ä½¿ç”¨è¡¨æƒ…ç¬¦å·ã€‚",
        "humorous": "é€‚å½“åŠ å…¥å¹½é»˜å…ƒç´ ï¼Œä½†ä¿æŒå°Šé‡ã€‚"
    }
    
    # ç»„è£…ç³»ç»Ÿæç¤º
    full_system_prompt = f"{system_prompt}\n\nå›å¤é£æ ¼ï¼š{style_instructions.get(personality, '')}"
    
    # é™åˆ¶å·¥å…·ä½¿ç”¨ï¼ˆç§Ÿæˆ·éš”ç¦»ï¼‰
    allowed_tools = configurable.get("allowed_tools", [])
    
    # è°ƒç”¨æ¨¡å‹ï¼ˆä¼ å…¥åŠ¨æ€ç³»ç»Ÿæç¤ºï¼‰
    messages = state["messages"]
    if messages and messages[0].type != "system":
        messages = [SystemMessage(content=full_system_prompt)] + messages
    
    response = model.invoke(messages)
    
    return {"messages": [response]}

def secure_kg_query(state: RegistrationState, config: RunnableConfig):
    """å¸¦ç§Ÿæˆ·éš”ç¦»çš„çŸ¥è¯†å›¾è°±æŸ¥è¯¢"""
    configurable = config.get("configurable", {})
    tenant_id = configurable.get("tenant_id")
    
    # åœ¨æŸ¥è¯¢ä¸­åŠ å…¥ç§Ÿæˆ·è¿‡æ»¤ï¼ˆå‡è®¾ KG èŠ‚ç‚¹æœ‰ tenant_id å±æ€§ï¼‰
    query = f"""
    MATCH (n:{tenant_id}_Student)-[r]->(m)
    RETURN n, r, m
    LIMIT 10
    """
    
    # æ‰§è¡ŒæŸ¥è¯¢...
    return {"kg_results": results}
```

**æ­¥éª¤ 4ï¼šå¤šç§Ÿæˆ·æ•°æ®éš”ç¦»ï¼ˆ1hï¼‰**

å®ç°å‘é‡åº“çš„ç§Ÿæˆ·éš”ç¦»ï¼š

```python
class TenantAwareVectorStore:
    """æ”¯æŒå¤šç§Ÿæˆ·çš„å‘é‡å­˜å‚¨"""
    
    def __init__(self, base_path: str = "./chroma_db"):
        self.base_path = base_path
        self.stores = {}
    
    def get_store(self, tenant_id: str):
        """è·å–æˆ–åˆ›å»ºç§Ÿæˆ·ä¸“å±çš„ Chroma å®ä¾‹"""
        if tenant_id not in self.stores:
            # æ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹ç›®å½•
            persist_dir = f"{self.base_path}/{tenant_id}"
            os.makedirs(persist_dir, exist_ok=True)
            
            self.stores[tenant_id] = Chroma(
                persist_directory=persist_dir,
                embedding_function=embeddings,
                collection_name=f"{tenant_id}_docs"
            )
        
        return self.stores[tenant_id]
    
    def query(self, tenant_id: str, query_text: str, k: int = 5):
        """ç§Ÿæˆ·éš”ç¦»æŸ¥è¯¢"""
        store = self.get_store(tenant_id)
        return store.similarity_search(query_text, k=k)

# åœ¨å·¥å…·ä¸­ä½¿ç”¨
@tool
def query_tenant_kg(question: str, config: RunnableConfig):
    tenant_id = config.get("configurable", {}).get("tenant_id")
    store = tenant_vector_store.get_store(tenant_id)
    return store.query(question)
```

**æ­¥éª¤ 5ï¼šé…ç½®åŠ¨æ€åˆ‡æ¢ï¼ˆ0.5hï¼‰**

æ¼”ç¤ºè¿è¡Œæ—¶åˆ‡æ¢é…ç½®ï¼š

```python
def demo_dynamic_config():
    """æ¼”ç¤ºä¸åŒé…ç½®ä¸‹çš„ Agent è¡Œä¸º"""
    app = create_adaptive_agent()
    
    # è®¡ç®—æœºå­¦é™¢å­¦ç”Ÿ
    cs_config = ConfigManager.build_runnable_config(
        user_id="cs_student_001",
        tenant_id="cs_dept",
        personality="professional"
    )
    
    # è‰ºæœ¯å­¦é™¢å­¦ç”Ÿ
    art_config = ConfigManager.build_runnable_config(
        user_id="art_student_001",
        tenant_id="art_dept",
        personality="friendly"
    )
    
    # åŒä¸€é—®é¢˜ï¼Œä¸åŒå›ç­”é£æ ¼
    question = "å¦‚ä½•å‡†å¤‡å¼€å­¦å…¸ç¤¼çš„å‘è¨€ï¼Ÿ"
    
    print("=== è®¡ç®—æœºå­¦é™¢ï¼ˆä¸“ä¸šé£æ ¼ï¼‰===")
    for event in app.stream({"messages": [HumanMessage(content=question)]}, cs_config):
        if "messages" in event:
            print(event["messages"][-1].content)
    
    print("\n=== è‰ºæœ¯å­¦é™¢ï¼ˆå‹å¥½é£æ ¼ï¼‰===")
    for event in app.stream({"messages": [HumanMessage(content=question)]}, art_config):
        if "messages" in event:
            print(event["messages"][-1].content)
```

**æ­¥éª¤ 6ï¼šæäº¤ï¼ˆ0.5hï¼‰**

```bash
git add .
git commit -m "feat(day8): å®ç°ä¸Šä¸‹æ–‡å·¥ç¨‹ä¸å¤šç§Ÿæˆ·éš”ç¦»
- è®¾è®¡ AgentConfig ä¸‰å±‚ä¸Šä¸‹æ–‡ï¼ˆState/Store/Runtimeï¼‰
- å®ç°ç§Ÿæˆ·é…ç½®ç®¡ç†ï¼ˆä¸åŒå­¦é™¢ä¸åŒçŸ¥è¯†åº“/æ¨¡å‹/äººæ ¼ï¼‰
- èŠ‚ç‚¹çº§åˆ«åŠ¨æ€è¯»å– RunnableConfigï¼Œå®ç°è‡ªé€‚åº”è¡Œä¸º
- å‘é‡åº“ä¸å›¾æ•°æ®åº“çš„ç§Ÿæˆ·ç‰©ç†éš”ç¦»
- é…ç½®éªŒè¯ä¸æƒé™æ§åˆ¶"
git push origin feature/day8-context-engineering
```

#### å…­ã€è€ƒæ ¸æ–¹æ³•ï¼ˆé‡åŒ–è¯„åˆ†ï¼Œ10 åˆ†ï¼‰

| è€ƒæ ¸é¡¹ | åˆ†å€¼ | è¯„åˆ†æ ‡å‡† |
|-------|------|---------|
| **é…ç½®æ¨¡å‹** | 2 åˆ† | å®šä¹‰ TypedDict/ dataclass é…ç½®ç»“æ„ï¼ŒåŒ…å« user/tenant/model/personality ç­‰å­—æ®µ |
| **é…ç½®ä¼ é€’** | 2 åˆ† | æ­£ç¡®ä½¿ç”¨ RunnableConfig çš„ configurable å­—æ®µï¼Œåœ¨èŠ‚ç‚¹å‡½æ•°ä¸­æ¥æ”¶å¹¶ä½¿ç”¨ config å‚æ•° |
| **ç§Ÿæˆ·éš”ç¦»** | 3 åˆ† | å®ç°æ•°æ®éš”ç¦»ï¼ˆä¸åŒ tenant_id è®¿é—®ä¸åŒå‘é‡é›†åˆ/å›¾æ•°æ®åº“ï¼‰ï¼Œæ— è¶Šæƒè®¿é—® |
| **åŠ¨æ€è¡Œä¸º** | 2 åˆ† | æ ¹æ®é…ç½®åŠ¨æ€è°ƒæ•´ç³»ç»Ÿæç¤ºï¼ˆå¦‚ä¸åŒäººæ ¼ï¼‰æˆ–æ¨¡å‹å‚æ•°ï¼ˆtemperatureï¼‰ |
| **é…ç½®éªŒè¯** | 1 åˆ† | éªŒè¯ tenant_id åˆæ³•æ€§ï¼Œé˜²æ­¢éæ³•é…ç½®ï¼ˆå¦‚ max_tokens è¶…é™ï¼‰ |

---

## Day 9ï¼šMCP åè®®ä¸å¤–éƒ¨ç³»ç»Ÿé›†æˆ

#### ä¸€ã€å‰æœŸçŸ¥è¯†ï¼ˆè¯¾å‰é¢„ä¹ ï¼Œ1hï¼‰

**å‚è€ƒèµ„æ–™**ï¼š
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/MCPåè®®è§„èŒƒ.md` - Model Context Protocol
- `docs/çŸ¥è¯†ç‚¹è¡¥å……/SSEä¸Stdioä¼ è¾“.md` - æœåŠ¡å™¨æ¨é€ä¸æ ‡å‡†è¾“å…¥è¾“å‡º

1. **MCP æ¶æ„**ï¼šHostã€Clientã€Server ä¸‰è§’å…³ç³»ï¼›
2. **ä¼ è¾“æ–¹å¼**ï¼šStdioï¼ˆæœ¬åœ°è¿›ç¨‹ï¼‰vs SSEï¼ˆHTTP æµå¼ï¼‰ï¼›
3. **å·¥å…·å‘ç°**ï¼š`tools/list` ç«¯ç‚¹ï¼Œ`tools/call` è°ƒç”¨ã€‚

#### äºŒã€å®éªŒç›®æ ‡

1. ç†è§£ MCP åè®®æ ¸å¿ƒæ¦‚å¿µï¼ˆResourcesã€Toolsã€Promptsï¼‰ï¼›
2. å¼€å‘ MCP Server å°è£…æ ¡åŠ¡ç³»ç»Ÿ APIï¼ˆæ•™åŠ¡ã€è´¢åŠ¡ã€å®¿ç®¡ï¼‰ï¼›
3. å®ç° LangGraph ä¸ MCP çš„æ¡¥æ¥ï¼Œä½¿ Agent èƒ½è°ƒç”¨å¤–éƒ¨ç³»ç»Ÿã€‚

#### ä¸‰ã€éš¾ç‚¹é‡ç‚¹

- **é‡ç‚¹**ï¼šMCP Server çš„ `tools/list` ä¸ `tools/call` å®ç°ï¼›
- **éš¾ç‚¹**ï¼šMCP ä¸ LangGraph çš„é›†æˆï¼ˆå°† MCP Tool è½¬ä¸º LangChain Toolï¼‰ã€‚

#### å››ã€çŸ¥è¯†åŸºç¡€

- **å¿…å¤‡**ï¼šHTTP API åŸºç¡€ï¼ŒJSON-RPC æ¦‚å¿µï¼›
- **å¯é€‰**ï¼šäº†è§£ gRPC æˆ– RESTful è®¾è®¡ã€‚

#### äº”ã€å®éªŒæ­¥éª¤ï¼ˆ8hï¼Œå« 2h ç†è®ºè®²è§£ï¼‰

**é˜¶æ®µ 1ï¼šç†è®ºè®²è§£ï¼ˆ2hï¼‰**

1. **MCP åè®®å…¨æ™¯**ï¼ˆ40minï¼‰ï¼š  
   - ä¸ºä»€ä¹ˆéœ€è¦ MCPï¼Ÿï¼ˆç»Ÿä¸€ AI ä¸å¤–éƒ¨ç³»ç»Ÿçš„æ¥å£ï¼‰  
   - ä¸ Function Calling çš„å¯¹æ¯”ï¼ˆæ ‡å‡†åŒ–ã€è·¨å¹³å°ï¼‰  
   - Resourcesï¼ˆèµ„æºï¼‰ã€Toolsï¼ˆå·¥å…·ï¼‰ã€Promptsï¼ˆæç¤ºæ¨¡æ¿ï¼‰  
2. **MCP Server å¼€å‘**ï¼ˆ40minï¼‰ï¼š  
   - FastMCP æ¡†æ¶ä½¿ç”¨ï¼ˆPython SDKï¼‰  
   - å·¥å…·è£…é¥°å™¨ `@mcp.tool()`  
   - ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰ä¸è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ  
3. **é›†æˆæ¨¡å¼**ï¼ˆ20minï¼‰ï¼š  
   - Stdio æ¨¡å¼ï¼ˆæœ¬åœ°å­è¿›ç¨‹ï¼‰  
   - SSE æ¨¡å¼ï¼ˆè¿œç¨‹æœåŠ¡ï¼‰  
   - LangGraph é€šè¿‡ `mcp.Client` è°ƒç”¨

**é˜¶æ®µ 2ï¼šå®æ“è½åœ°ï¼ˆ6hï¼‰**

**æ­¥éª¤ 1ï¼šç¯å¢ƒå‡†å¤‡ï¼ˆ0.5hï¼‰**

```bash
git checkout -b feature/day9-mcp-integration
uv pip install mcp langchain-mcp-adapters -i https://pypi.tuna.tsinghua.edu.cn/simple
```

**æ­¥éª¤ 2ï¼šå¼€å‘ MCP Serverï¼ˆ2hï¼‰**

åˆ›å»º `mcp_servers/campus_service.py`ï¼š

```python
from mcp.server.fastmcp import FastMCP
import json
from datetime import datetime

# åˆ›å»º MCP Server
mcp = FastMCP("campus_service")

# æ¨¡æ‹Ÿæ ¡åŠ¡ç³»ç»Ÿæ•°æ®åº“
MOCK_DB = {
    "students": {
        "2024001": {"name": "ææ˜", "tuition_paid": False, "dorm_assigned": "A1-301"},
        "2024002": {"name": "ç‹èŠ³", "tuition_paid": True, "dorm_assigned": "A2-205"}
    },
    "courses": {
        "CS101": {"name": "Pythonç¼–ç¨‹", "capacity": 100, "enrolled": 85},
        "CS102": {"name": "æ•°æ®ç»“æ„", "capacity": 80, "enrolled": 78}
    }
}

@mcp.tool()
def check_tuition_status(student_id: str) -> str:
    """
    æŸ¥è¯¢å­¦ç”Ÿç¼´è´¹çŠ¶æ€
    Args:
        student_id: å­¦ç”Ÿå­¦å·ï¼Œå¦‚"2024001"
    """
    student = MOCK_DB["students"].get(student_id)
    if not student:
        return json.dumps({"error": "å­¦ç”Ÿä¸å­˜åœ¨"}, ensure_ascii=False)
    
    status = "å·²ç¼´è´¹" if student["tuition_paid"] else "æœªç¼´è´¹"
    return json.dumps({
        "student_id": student_id,
        "name": student["name"],
        "tuition_status": status,
        "timestamp": datetime.now().isoformat()
    }, ensure_ascii=False)

@mcp.tool()
def assign_dormitory(student_id: str, building: str, room: str) -> str:
    """
    åˆ†é…å®¿èˆï¼ˆå®¿ç®¡ç³»ç»Ÿæ¥å£ï¼‰
    Args:
        student_id: å­¦ç”Ÿå­¦å·
        building: æ¥¼æ ‹ï¼Œå¦‚"A1"
        room: æˆ¿é—´å·ï¼Œå¦‚"301"
    """
    if student_id not in MOCK_DB["students"]:
        return json.dumps({"error": "å­¦ç”Ÿä¸å­˜åœ¨"}, ensure_ascii=False)
    
    dorm_id = f"{building}-{room}"
    MOCK_DB["students"][student_id]["dorm_assigned"] = dorm_id
    
    return json.dumps({
        "success": True,
        "student_id": student_id,
        "dormitory": dorm_id,
        "message": f"æˆåŠŸåˆ†é…å®¿èˆï¼š{dorm_id}"
    }, ensure_ascii=False)

@mcp.tool()
def query_course_enrollment(course_id: str) -> str:
    """
    æŸ¥è¯¢è¯¾ç¨‹é€‰è¯¾äººæ•°ï¼ˆæ•™åŠ¡ç³»ç»Ÿæ¥å£ï¼‰
    Args:
        course_id: è¯¾ç¨‹ä»£ç ï¼Œå¦‚"CS101"
    """
    course = MOCK_DB["courses"].get(course_id)
    if not course:
        return json.dumps({"error": "è¯¾ç¨‹ä¸å­˜åœ¨"}, ensure_ascii=False)
    
    remaining = course["capacity"] - course["enrolled"]
    return json.dumps({
        "course_id": course_id,
        "course_name": course["name"],
        "capacity": course["capacity"],
        "enrolled": course["enrolled"],
        "remaining": remaining,
        "status": "å·²æ»¡" if remaining <= 0 else "å¯é€‰è¯¾"
    }, ensure_ascii=False)

@mcp.resource("student://{student_id}/profile")
def get_student_profile(student_id: str) -> str:
    """
    MCP Resourceï¼šè·å–å­¦ç”Ÿæ¡£æ¡ˆï¼ˆURI è®¿é—®æ¨¡å¼ï¼‰
    """
    student = MOCK_DB["students"].get(student_id)
    if not student:
        return "å­¦ç”Ÿä¸å­˜åœ¨"
    
    return json.dumps(student, ensure_ascii=False, indent=2)

if __name__ == "__main__":
    # å¯åŠ¨ Serverï¼ˆStdio æ¨¡å¼ï¼‰
    mcp.run(transport='stdio')
```

**æ­¥éª¤ 3ï¼šLangGraph æ¡¥æ¥ï¼ˆ1.5hï¼‰**

åœ¨ `agents/mcp_bridge.py` ä¸­å®ç°æ¡¥æ¥ï¼š

```python
from langchain_mcp_adapters.tools import load_mcp_tools
from mcp import ClientSession, StdioServerParameters
from langchain_core.tools import Tool
import subprocess

class MCPClient:
    """MCP å®¢æˆ·ç«¯å°è£…"""
    
    def __init__(self):
        self.session = None
        self.tools = []
    
    async def connect(self, server_script_path: str):
        """è¿æ¥åˆ° MCP Serverï¼ˆStdio æ¨¡å¼ï¼‰"""
        server_params = StdioServerParameters(
            command="python",
            args=[server_script_path],
            env=None
        )
        
        # å¯åŠ¨è¿›ç¨‹å¹¶å»ºç«‹ä¼šè¯ï¼ˆç®€åŒ–ç¤ºæ„ï¼Œå®é™…ä½¿ç”¨ contextlibï¼‰
        process = await subprocess.create_subprocess_exec(
            server_params.command,
            *server_params.args,
            stdin=subprocess.PIPE,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE
        )
        
        # è¿™é‡Œåº”ä½¿ç”¨ mcp.ClientSession è¿›è¡Œåˆå§‹åŒ–åå•†
        # ä¸ºç®€åŒ–ï¼Œç›´æ¥ä½¿ç”¨ langchain-mcp-adapters
        self.session = ClientSession(...)  # å®é™…åˆå§‹åŒ–
        
        # åŠ è½½å·¥å…·
        self.tools = await load_mcp_tools(self.session)
        print(f"âœ… å·²åŠ è½½ {len(self.tools)} ä¸ª MCP å·¥å…·")
        return self.tools
    
    async def call_tool(self, tool_name: str, arguments: dict):
        """è°ƒç”¨ç‰¹å®šå·¥å…·"""
        if not self.session:
            raise RuntimeError("æœªè¿æ¥åˆ° MCP Server")
        
        result = await self.session.call_tool(tool_name, arguments)
        return result

# åŒæ­¥åŒ…è£…å™¨ï¼ˆé€‚é… LangGraphï¼‰
def create_sync_tools(server_path: str):
    """å°†å¼‚æ­¥ MCP å·¥å…·è½¬ä¸ºåŒæ­¥ LangChain Tools"""
    import asyncio
    
    client = MCPClient()
    tools = asyncio.run(client.connect(server_path))
    
    # åŒ…è£…ä¸º LangChain Tool
    langchain_tools = []
    for tool in tools:
        langchain_tools.append(
            Tool(
                name=tool.name,
                description=tool.description,
                func=lambda args, tool=tool: asyncio.run(tool.ainvoke(args)),
                args_schema=tool.args_schema
            )
        )
    
    return langchain_tools
```

**æ­¥éª¤ 4ï¼šé›†æˆåˆ° Agentï¼ˆ1hï¼‰**

åœ¨ `agents/day9_mcp_agent.py` ä¸­ä½¿ç”¨ï¼š

```python
from agents.mcp_bridge import create_sync_tools
from langgraph.prebuilt import create_react_agent

# åŠ è½½ MCP å·¥å…·
mcp_tools = create_sync_tools("mcp_servers/campus_service.py")

# ç»“åˆä¹‹å‰çš„å·¥å…·
from agents.tools.campus_info import query_campus_library_status
all_tools = [query_campus_library_status] + mcp_tools

# åˆ›å»º Agent
mcp_agent = create_react_agent(
    model=model,
    tools=all_tools,
    system_prompt="""ä½ æ˜¯æ ¡å›­åŠ©æ‰‹ï¼Œå¯ä»¥è®¿é—®ä»¥ä¸‹ç³»ç»Ÿï¼š
- è´¢åŠ¡ç³»ç»Ÿï¼šæŸ¥è¯¢ç¼´è´¹çŠ¶æ€
- å®¿ç®¡ç³»ç»Ÿï¼šåˆ†é…å®¿èˆ
- æ•™åŠ¡ç³»ç»Ÿï¼šæŸ¥è¯¢é€‰è¯¾æƒ…å†µ
è¯·æ ¹æ®å­¦ç”Ÿéœ€æ±‚è°ƒç”¨ç›¸åº”å·¥å…·ã€‚"""
)

def handle_registration_with_mcp(student_input: str):
    """å¤„ç†åŒ…å«å¤–éƒ¨ç³»ç»Ÿè°ƒç”¨çš„æŠ¥åˆ°è¯·æ±‚"""
    result = mcp_agent.invoke({
        "messages": [HumanMessage(content=student_input)]
    })
    return result["messages"][-1].content

# æµ‹è¯•
if __name__ == "__main__":
    # æµ‹è¯•ç¼´è´¹æŸ¥è¯¢
    print(handle_registration_with_mcp("æŸ¥è¯¢æˆ‘çš„ç¼´è´¹çŠ¶æ€ï¼Œå­¦å·2024001"))
    
    # æµ‹è¯•å®¿èˆåˆ†é…ï¼ˆéœ€è¦æƒé™ï¼‰
    print(handle_registration_with_mcp("ç»™æˆ‘åˆ†é…A1æ¥¼çš„å®¿èˆ"))
```

**æ­¥éª¤ 5ï¼šSSE æ¨¡å¼éƒ¨ç½²ï¼ˆ0.5hï¼‰**

å°† MCP Server éƒ¨ç½²ä¸º HTTP æœåŠ¡ï¼š

```python
# mcp_servers/campus_service_http.py
from mcp.server.fastmcp import FastMCP

mcp = FastMCP("campus_service")

@mcp.tool()
def check_tuition_status(student_id: str) -> str:
    # ... åŒä¸Š ...

if __name__ == "__main__":
    # SSE æ¨¡å¼ï¼ˆHTTP æµå¼ï¼‰
    mcp.run(transport='sse', port=8001)
```

ä¿®æ”¹å®¢æˆ·ç«¯è¿æ¥æ–¹å¼ï¼š

```python
from mcp.client.sse import sse_client

async def connect_sse():
    async with sse_client("http://localhost:8001/sse") as (read, write):
        session = ClientSession(read, write)
        # ... åˆå§‹åŒ– ...
```

**æ­¥éª¤ 6ï¼šæäº¤ï¼ˆ0.5hï¼‰**

```bash
git add .
git commit -m "feat(day9): å®ç° MCP åè®®ä¸æ ¡åŠ¡ç³»ç»Ÿé›†æˆ
- å¼€å‘ MCP Server å°è£…è´¢åŠ¡/å®¿ç®¡/æ•™åŠ¡ç³»ç»Ÿï¼ˆ3ä¸ªtools + 1ä¸ªresourceï¼‰
- å®ç° MCP Stdio ä¸ SSE ä¸¤ç§ä¼ è¾“æ¨¡å¼
- ä½¿ç”¨ langchain-mcp-adapters æ¡¥æ¥ MCP ä¸ LangGraph
- Agent æˆåŠŸè°ƒç”¨å¤–éƒ¨æ ¡åŠ¡ç³»ç»Ÿ API
- å®ç°å®¿èˆåˆ†é…ã€ç¼´è´¹æŸ¥è¯¢ã€è¯¾ç¨‹æŸ¥è¯¢åŠŸèƒ½"
git push origin feature/day9-mcp-integration
```

#### å…­ã€è€ƒæ ¸æ–¹æ³•ï¼ˆé‡åŒ–è¯„åˆ†ï¼Œ10 åˆ†ï¼‰

| è€ƒæ ¸é¡¹ | åˆ†å€¼ | è¯„åˆ†æ ‡å‡† |
|-------|------|---------|
| **MCP Server** | 3 åˆ† | å®ç°è‡³å°‘ 3 ä¸ª Toolï¼ˆ@mcp.tool()ï¼‰ï¼ŒåŒ…å«å‚æ•°æè¿°ï¼Œè¿”å› JSON æ ¼å¼æ•°æ® |
| **èµ„æºå®šä¹‰** | 1 åˆ† | å®šä¹‰è‡³å°‘ 1 ä¸ª Resourceï¼ˆ@mcp.resource()ï¼‰ï¼Œä½¿ç”¨ URI æ¨¡å¼è®¿é—® |
| **åè®®åˆè§„** | 2 åˆ† | æ­£ç¡®å®ç° tools/list ä¸ tools/callï¼Œç¬¦åˆ MCP åè®®è§„èŒƒ |
| **LangGraph é›†æˆ** | 2 åˆ† | æˆåŠŸå°† MCP Tool è½¬ä¸º LangChain Toolï¼ŒAgent èƒ½æ­£ç¡®è°ƒç”¨å¹¶å¤„ç†ç»“æœ |
| **åŒæ¨¡å¼æ”¯æŒ** | 1 åˆ† | åŒæ—¶æ”¯æŒ Stdioï¼ˆæœ¬åœ°ï¼‰å’Œ SSEï¼ˆè¿œç¨‹ï¼‰ä¸¤ç§ä¼ è¾“æ¨¡å¼ |
| **ä¸šåŠ¡åœºæ™¯** | 1 åˆ† | è¦†ç›–è‡³å°‘ä¸¤ä¸ªæ ¡åŠ¡åœºæ™¯ï¼ˆå¦‚è´¢åŠ¡æŸ¥è¯¢+å®¿èˆåˆ†é…ï¼‰ï¼Œæ•°æ®æµè½¬æ­£ç¡® |

---

## æ€»ç»“ä¸æäº¤è§„èŒƒ

### 9 å¤©ç´¯è®¡æäº¤æ£€æŸ¥ç‚¹

```bash
# æœ€ç»ˆåˆå¹¶åˆ° dev åˆ†æ”¯
git checkout dev
git merge feature/day1-react-agent
git merge feature/day2-rag-system
git merge feature/day3-knowledge-graph
git merge feature/day4-state-graph
git merge feature/day5-security-middleware
git merge feature/day6-hitl
git merge feature/day7-memory-system
git merge feature/day8-context-engineering
git merge feature/day9-mcp-integration

git push origin dev
```

### é¡¹ç›®ç»“æ„æœ€ç»ˆå½¢æ€

```
smart-campus-mas/
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ day1_react_agent.py      # åŸºç¡€ ReAct
â”‚   â”œâ”€â”€ day2_rag_agent.py        # RAG é›†æˆ
â”‚   â”œâ”€â”€ day4_state_graph.py      # çŠ¶æ€æœº
â”‚   â”œâ”€â”€ day6_hitl_agent.py       # äººæœºäº¤äº’
â”‚   â”œâ”€â”€ day9_mcp_agent.py        # MCP é›†æˆ
â”‚   â””â”€â”€ tools/
â”‚       â”œâ”€â”€ campus_info.py       # Day1 å·¥å…·
â”‚       â””â”€â”€ kg_tools.py          # Day3 å·¥å…·
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ vector_store.py          # Day2 å‘é‡åº“
â”‚   â”œâ”€â”€ neo4j_client.py          # Day3 å›¾æ•°æ®åº“
â”‚   â””â”€â”€ memory_store.py          # Day7 é•¿æœŸè®°å¿†
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ base.py                  # Day5 ä¸­é—´ä»¶åŸºç±»
â”‚   â””â”€â”€ security_layers.py       # Day5 å››å±‚é˜²æŠ¤
â”œâ”€â”€ mcp_servers/
â”‚   â””â”€â”€ campus_service.py        # Day9 MCP æœåŠ¡
â”œâ”€â”€ config/
â”‚   â””â”€â”€ runtime_config.py        # Day8 å¤šç§Ÿæˆ·é…ç½®
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_security.py         # Day5 å®‰å…¨æµ‹è¯•
â”‚   â””â”€â”€ test_rag.py              # Day2 RAG æµ‹è¯•
â”œâ”€â”€ data/
â”‚   â””â”€â”€ æ–°ç”ŸæŠ¥åˆ°æ‰‹å†Œ.pdf          # Day2 æ•°æ®æº
â””â”€â”€ README.md                    # æ¶æ„è¯´æ˜ä¸è¿è¡ŒæŒ‡å—
```

æ­¤æ–¹æ¡ˆç¡®ä¿äº†**ä»åŸºç¡€ Agent åˆ°ç”Ÿäº§çº§ MAS çš„æ¸è¿›å¼æ„å»º**ï¼Œæ¯ä¸€å¤©éƒ½æœ‰æ˜ç¡®çš„äº¤ä»˜ç‰©ã€å¯é‡åŒ–çš„è¯„åˆ†æ ‡å‡†å’ŒçœŸå®çš„ä¸šåŠ¡ä»·å€¼æ˜ å°„ã€‚éœ€è¦æˆ‘ä¸ºç‰¹å®šæŸä¸€å¤©ï¼ˆå¦‚ Day 4 çš„ StateGraph å¯è§†åŒ–æˆ– Day 7 çš„ Postgres é…ç½®ï¼‰æä¾›æ›´è¯¦ç»†çš„ä»£ç å®ç°å—ï¼Ÿ